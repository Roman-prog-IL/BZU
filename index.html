<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калории / БЖУ — Твой Трекер</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --text:#e8edf6; --mut:#8ea0b8;
      --acc:#4da3ff; --ok:#44d07b; --bad:#ff5a6a; --bd:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 92px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .date{font-weight:800;font-size:16px;line-height:1.2}
    .subdate{font-size:12px;color:var(--mut);font-weight:600;margin-top:2px}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;color:var(--mut);font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .k{border:1px solid var(--bd);border-radius:12px;padding:10px;min-height:82px}
    .k .v{font-size:18px;font-weight:900}
    .k .l{font-size:11px;color:var(--mut);margin-top:2px}

    .inp, select{
      width:100%;
      background:#0e1420;
      border:1px solid var(--bd);
      color:var(--text);
      border-radius:12px;
      padding:10px;
      font-size:14px;
      outline:none
    }
    .inp:focus, select:focus{border-color:rgba(77,163,255,.6)}

    .btn{
      background:#0e1420;
      border:1px solid var(--bd);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap
    }
    .btn:active{transform:translateY(1px)}
    .btn.acc{border-color:rgba(77,163,255,.7);background:rgba(77,163,255,.08)}
    .btn.ok{border-color:rgba(68,208,123,.7);background:rgba(68,208,123,.08)}
    .btn.bad{border-color:rgba(255,90,106,.7);background:rgba(255,90,106,.08)}

    .mini{font-size:12px;color:var(--mut)}
    .sectionTitle{display:flex;align-items:flex-end;justify-content:space-between;margin:0 0 8px 0}
    .sectionTitle h3{margin:0;font-size:14px}

    .list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .item{
      border:1px solid var(--bd);
      border-radius:12px;
      padding:10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px;
      align-items:center
    }
    .item .name{font-weight:900}
    .item .sub{font-size:12px;color:var(--mut);margin-top:2px}
    .item .actions{display:flex;gap:6px;justify-content:flex-end}

    .tag{font-size:11px;color:var(--mut);border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
    .rightCol{display:flex;flex-direction:column;gap:10px}

    .three{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.three{grid-template-columns:1fr 1fr 1fr}}

    .hint{font-size:11px;color:var(--mut);margin-top:6px}
    .sep{height:1px;background:var(--bd);margin:10px 0}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    /* ЦЕЛИ БЖУ */
    .kHead{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
    .goalWrap{display:flex;flex-direction:column;align-items:flex-end;gap:4px;min-width:72px}
    .goalLbl{font-size:10px;color:var(--mut);line-height:1}
    .goalInp{
      width:72px;
      background:#0e1420;
      border:1px solid var(--bd);
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      outline:none;
      text-align:right;
    }
    .goalInp:focus{border-color:rgba(77,163,255,.6)}
    .goalNote{font-size:10px;color:var(--mut);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .historyBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(11,15,20,.9);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--bd);
      padding:10px;
    }
    .historyInner{max-width:860px;margin:0 auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .historyLabel{font-size:12px;color:var(--mut);font-weight:700}
    .historyDate{min-width:160px;max-width:220px}
    .tiny{font-size:11px;color:var(--mut)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="date" id="dateText">—</div>
      <div class="subdate" id="dayKeyText">—</div>
    </div>
    <div class="pill" id="saveState">сохранено</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="sectionTitle">
        <h3>Итоги дня</h3>
        <span class="tag" id="modeTag">сегодня</span>
      </div>

      <div class="kpi">
        <div class="k" id="kcalCard">
          <div class="kHead">
            <div>
              <div class="v" id="kcal">0</div>
              <div class="l">ккал (еда)</div>
            </div>
            <div class="goalWrap">
              <div class="goalLbl">цель</div>
              <input class="goalInp" id="goalK" type="number" inputmode="numeric" step="10" placeholder="—">
            </div>
          </div>
          <div class="goalNote" id="kcalNote"></div>
        </div>

        <div class="k">
          <div class="kHead">
            <div>
              <div class="v" id="p">0.0</div>
              <div class="l">Белки, г</div>
            </div>
            <div class="goalWrap">
              <div class="goalLbl">цель</div>
              <input class="goalInp" id="goalP" type="number" inputmode="numeric" step="1" placeholder="—">
            </div>
          </div>
          <div class="goalNote" id="noteP"></div>
        </div>

        <div class="k">
          <div class="kHead">
            <div>
              <div class="v" id="f">0.0</div>
              <div class="l">Жиры, г</div>
            </div>
            <div class="goalWrap">
              <div class="goalLbl">цель</div>
              <input class="goalInp" id="goalF" type="number" inputmode="numeric" step="1" placeholder="—">
            </div>
          </div>
          <div class="goalNote" id="noteF"></div>
        </div>

        <div class="k">
          <div class="kHead">
            <div>
              <div class="v" id="c">0.0</div>
              <div class="l">Углеводы, г</div>
            </div>
            <div class="goalWrap">
              <div class="goalLbl">цель</div>
              <input class="goalInp" id="goalC" type="number" inputmode="numeric" step="1" placeholder="—">
            </div>
          </div>
          <div class="goalNote" id="noteC"></div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="three">
        <div>
          <div class="mini">Вес (кг)</div>
          <input class="inp" id="weight" type="number" inputmode="decimal" step="0.1" placeholder="например 73.0">
        </div>

        <div>
          <div class="mini">Тренировка (ккал)</div>
          <input class="inp" id="workout" type="number" inputmode="numeric" step="1" placeholder="например 350">
          <div class="hint">введи сколько сжёг</div>
        </div>

        <div>
          <div class="mini">Вода (литры)</div>
          <input class="inp" id="water" type="number" inputmode="decimal" step="0.1" placeholder="например 2.3">
          <div class="quick">
            <button class="btn acc" type="button" data-water="0.15">+150 мл</button>
            <button class="btn acc" type="button" data-water="0.20">+200 мл</button>
            <button class="btn bad" type="button" id="waterClear">сброс</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">
        <h3>Добавить продукт</h3>
        <span class="tag" id="foodsCount">0</span>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input class="inp" id="foodSearch" placeholder="поиск по твоим продуктам..." />
      </div>

      <div class="row">
        <select id="foodSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1;min-width:200px">
          <div class="mini">Граммы</div>
          <input class="inp" id="grams" type="number" inputmode="numeric" step="1" value="100">
          <div class="quick">
            <button class="btn acc" type="button" data-g="150">150 г</button>
            <button class="btn acc" type="button" data-g="200">200 г</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <button class="btn ok" id="addBtn">в день</button>
          <button class="btn acc" id="customBtn">в базу</button>
          <button class="btn bad" id="deleteFromBaseBtn">удалить из базы</button>
        </div>
      </div>

      <div class="hint" id="selInfo">сначала добавь продукты в базу</div>

      <div class="list" id="list"></div>

      <div class="sep"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn bad" id="clearDay">очистить день</button>
        <button class="btn" id="exportBtn">экспорт</button>
      </div>
    </div>

    <div class="rightCol">
      <div class="card">
        <div class="sectionTitle">
          <h3>Быстро</h3>
          <span class="mini">сохранение авто</span>
        </div>
        <div class="row">
          <button class="btn" id="copyTotals">скопировать итоги</button>
          <button class="btn bad" id="resetAll">сбросить всё</button>
        </div>
      </div>

      <div class="card">
        <div class="sectionTitle">
          <h3>Подсказка</h3>
          <span class="mini">рекомпозиция</span>
        </div>
        <div class="tiny">
          Цели для тебя (73кг):<br>
          Ккал: 1900 • Б: 145 • Ж: 75 • У: 170
        </div>
      </div>
    </div>
  </div>
</div>

<div class="historyBar">
  <div class="historyInner">
    <span class="historyLabel">День:</span>
    <input class="inp historyDate" id="dayPicker" type="date" />
    <button class="btn" id="prevDay" type="button">◀</button>
    <button class="btn" id="nextDay" type="button">▶</button>
    <button class="btn acc" id="goToday" type="button">Сегодня</button>
    <span class="pill" id="dayHint">—</span>
  </div>
</div>

<script>
(() => {
  const CUSTOM_FOODS_KEY = "kcal_tracker_custom_foods_v1";
  const GOALS_KEY = "kcal_tracker_goals_v1";
  const KEY = "kcal_tracker_v1";

  let FOODS = [];
  const goals = { k:"", p:"", f:"", c:"" };
  const state = { days: {} };
  let currentKey = new Date().toISOString().split('T')[0];

  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=0) => (Number.isFinite(n) ? n.toFixed(d) : "0");
  const round1 = (n) => Math.round(n * 10) / 10;

  function loadCustomFoods(){
    try {
      const raw = localStorage.getItem(CUSTOM_FOODS_KEY);
      FOODS = raw ? JSON.parse(raw) : [];
    } catch(e) { FOODS = []; }
  }

  function saveCustomFoods(){
    localStorage.setItem(CUSTOM_FOODS_KEY, JSON.stringify(FOODS));
  }

  function loadGoals(){
    try {
      const raw = localStorage.getItem(GOALS_KEY);
      if(raw) Object.assign(goals, JSON.parse(raw));
    } catch(e){}
    $("goalK").value = goals.k;
    $("goalP").value = goals.p;
    $("goalF").value = goals.f;
    $("goalC").value = goals.c;
  }

  function saveGoals(){
    localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
  }

  function ensureDay(key) {
    if(!state.days[key]) state.days[key] = { items: [], waterL: "", weight: "", workoutKcal: "" };
    return key;
  }

  function dayObj() { return state.days[currentKey]; }

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if(raw) Object.assign(state, JSON.parse(raw));
    } catch(e){}
    loadCustomFoods();
    loadGoals();
    ensureDay(currentKey);
    render();
    rebuildSelect("");
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(state));
    flashSaved();
  }

  function flashSaved() {
    const el = $("saveState");
    el.textContent = "сохранено";
    el.style.borderColor = "rgba(68,208,123,.6)";
    setTimeout(() => { el.style.borderColor = "var(--bd)"; }, 500);
  }

  function totals() {
    const items = dayObj().items;
    let kcal=0,p=0,f=0,c=0;
    for(const it of items){
      const mul = (Number(it.grams)||0)/100;
      kcal += (it.per100.kcal||0)*mul;
      p += (it.per100.p||0)*mul;
      f += (it.per100.f||0)*mul;
      c += (it.per100.c||0)*mul;
    }
    return {kcal,p,f,c};
  }

  function goalLine(consumed, goal){
    const g = Number(goal);
    if(!g) return "";
    const diff = round1(g - consumed);
    return diff > 0 ? `осталось ${fmt(diff,1)} г` : `перебор ${fmt(Math.abs(diff),1)} г`;
  }

  function setKpis() {
    const t = totals();
    const d = dayObj();
    const eatenKcal = Math.round(t.kcal);
    
    $("kcal").textContent = eatenKcal;
    $("p").textContent = fmt(t.p,1);
    $("f").textContent = fmt(t.f,1);
    $("c").textContent = fmt(t.c,1);

    $("noteP").textContent = goalLine(t.p, goals.p);
    $("noteF").textContent = goalLine(t.f, goals.f);
    $("noteC").textContent = goalLine(t.c, goals.c);

    const burned = Math.round(Number(d.workoutKcal)||0);
    const net = eatenKcal - burned;
    const gK = Number(goals.k);
    
    let status = `Нетто: ${net}`;
    if(burned > 0) status = `Трен: -${burned} • ` + status;
    if(gK > 0) {
      const diff = gK - net;
      status += diff > 0 ? ` • еще ${diff} ккал` : ` • перебор ${Math.abs(diff)} ккал`;
    }
    $("kcalNote").textContent = status;
  }

  function rebuildSelect(filter="") {
    const f = filter.toLowerCase();
    foodSelect.innerHTML = "";
    const filtered = FOODS.filter(x => x.name.toLowerCase().includes(f))
                          .sort((a,b) => a.name.localeCompare(b.name));
    filtered.forEach(x => {
      const opt = document.createElement("option");
      opt.value = x.name; opt.textContent = x.name;
      foodSelect.appendChild(opt);
    });
    foodsCount.textContent = filtered.length;
    updateSelInfo();
  }

  function updateSelInfo() {
    const f = FOODS.find(x => x.name === foodSelect.value);
    selInfo.textContent = f ? `100г: ${f.kcal} ккал • Б${f.p} Ж${f.f} У${f.c}` : "добавьте продукты";
  }

  function renderList() {
    listEl.innerHTML = "";
    dayObj().items.forEach((it, idx) => {
      const mul = it.grams/100;
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div><div class="name">${it.name}</div>
        <div class="sub">${it.grams}г • ${Math.round(it.per100.kcal*mul)}ккал • Б${fmt(it.per100.p*mul,1)} Ж${fmt(it.per100.f*mul,1)}</div></div>
        <div class="actions"><button class="btn bad" onclick="window.delIt(${idx})">×</button></div>`;
      listEl.appendChild(div);
    });
  }

  window.delIt = (i) => { dayObj().items.splice(i,1); save(); render(); };

  function render() {
    renderList();
    setKpis();
    const d = dayObj();
    $("weight").value = d.weight;
    $("water").value = d.waterL;
    $("workout").value = d.workoutKcal;
    $("dateText").textContent = currentKey;
  }

  // Events
  $("goalK").oninput = (e) => { goals.k = e.target.value; saveGoals(); setKpis(); };
  $("goalP").oninput = (e) => { goals.p = e.target.value; saveGoals(); setKpis(); };
  $("goalF").oninput = (e) => { goals.f = e.target.value; saveGoals(); setKpis(); };
  $("goalC").oninput = (e) => { goals.c = e.target.value; saveGoals(); setKpis(); };

  $("addBtn").onclick = () => {
    const f = FOODS.find(x => x.name === foodSelect.value);
    if(!f) return;
    dayObj().items.unshift({name: f.name, grams: $("grams").value, per100: f});
    save(); render();
  };

  $("customBtn").onclick = () => {
    const name = prompt("Название:"); if(!name) return;
    const n = { name, kcal: +prompt("Ккал:"), p: +prompt("Б:"), f: +prompt("Ж:"), c: +prompt("У:") };
    FOODS.push(n); saveCustomFoods(); rebuildSelect();
  };

  $("weight").oninput = (e) => { dayObj().weight = e.target.value; save(); };
  $("water").oninput = (e) => { dayObj().waterL = e.target.value; save(); };
  $("workout").oninput = (e) => { dayObj().workoutKcal = e.target.value; save(); setKpis(); };

  $("dayPicker").onchange = (e) => { currentKey = e.target.value; ensureDay(currentKey); render(); };
  $("goToday").onclick = () => { currentKey = new Date().toISOString().split('T')[0]; $("dayPicker").value = currentKey; ensureDay(currentKey); render(); };

  load();
})();
</script>
</body>
</html>
