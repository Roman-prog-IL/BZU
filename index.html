<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ë–ñ–£ ‚Äî –ü–æ—Ä—Ü–∏–∏</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e6edf3}
  .wrap{max-width:820px;margin:auto;padding:16px}
  .card{background:#111826;border:1px solid #223044;border-radius:16px;padding:14px;margin-bottom:12px}
  h1{margin:0 0 6px;font-size:22px}
  h2{margin:0 0 10px;font-size:16px;opacity:.95}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,button{
    background:#0b1220;color:#e6edf3;border:1px solid #223044;border-radius:12px;
    padding:10px 12px;font-size:16px
  }
  select{min-width:240px}
  input[type="number"]{width:120px}
  button{cursor:pointer}
  .primary{background:#1f6feb;border-color:#1f6feb}
  .danger{background:#b42318;border-color:#b42318}
  .pill{padding:8px 12px;border:1px solid #223044;border-radius:999px;background:#0b1220}
  .sep{height:1px;background:#223044;margin:10px 0}
  .small{font-size:13px;opacity:.8}
  .list{list-style:none;padding:0;margin:10px 0 0}
  .item{background:#0b1220;border:1px solid #223044;border-radius:14px;padding:10px;margin-bottom:8px}
  .itemTop{display:flex;justify-content:space-between;gap:10px}
  .itemName{font-weight:700}
  .right{text-align:right}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>–ë–ñ–£ / –ü–æ—Ä—Ü–∏–∏</h1>
  <div class="row small" style="margin-bottom:10px">
    <span class="pill">üìÖ –î–µ–Ω—å: <b id="uiDate" class="mono"></b></span>
    <button id="prevDay">‚Üê</button>
    <button id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
    <button id="nextDay">‚Üí</button>
    <button id="resetDay" class="danger">–°–±—Ä–æ—Å –¥–Ω—è</button>
  </div>

  <div class="card">
    <h2>–ò—Ç–æ–≥–∏</h2>
    <div class="row">
      <span class="pill">üçΩÔ∏è –°—ä–µ–ª: <b id="uiInK">0</b> –∫–∫–∞–ª</span>
      <span class="pill">üî• –°–æ–∂–∂–µ–Ω–æ: <b id="uiBurnK">0</b> –∫–∫–∞–ª</span>
      <span class="pill">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: <b id="uiNetK">0</b> –∫–∫–∞–ª</span>
      <span class="pill">üíß –í–æ–¥–∞: <b id="uiWaterMl">0</b> –º–ª</span>
    </div>
    <div class="sep"></div>
    <div class="row">
      <span class="pill">–ë <b id="uiP">0.0</b> –≥</span>
      <span class="pill">–ñ <b id="uiF">0.0</b> –≥</span>
      <span class="pill">–£ <b id="uiC">0.0</b> –≥</span>
    </div>
  </div>

  <div class="card">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º</h2>
    <div class="row">
      <select id="foodSel"></select>
      <input id="qtyInp" type="number" step="0.5" placeholder="–ø–æ—Ä—Ü–∏–∏">
      <button id="addMeal" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="small" style="margin-top:8px">–ü—Ä–æ–¥—É–∫—Ç—ã –∑–∞–¥–∞—é—Ç—Å—è <b>–∑–∞ 1 –ø–æ—Ä—Ü–∏—é</b>. –ü–æ—Ä—Ü–∏–∏ –º–æ–∂–Ω–æ –¥—Ä–æ–±–Ω—ã–µ (0.5).</div>

    <ul class="list" id="logList"></ul>
  </div>

  <div class="grid2">
    <div class="card">
      <h2>–í–æ–¥–∞</h2>
      <div class="row">
        <button data-w="200">+200</button>
        <button data-w="300">+300</button>
        <button data-w="500">+500</button>
        <button id="waterReset" class="danger">–°–±—Ä–æ—Å</button>
      </div>
      <div class="small" style="margin-top:8px">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.</div>
    </div>

    <div class="card">
      <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
      <div class="row">
        <input id="burnInp" type="number" placeholder="–∫–∫–∞–ª">
        <button id="burnAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="burnReset" class="danger">–°–±—Ä–æ—Å</button>
      </div>
      <div class="small" style="margin-top:8px">–°—é–¥–∞ –≤–≤–æ–¥–∏ –∫–∞–ª–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã —Å–∂—ë–≥ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.</div>
    </div>
  </div>

  <div class="card">
    <h2>–ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é)</h2>
    <div class="row">
      <input id="pName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <input id="pP" type="number" step="0.1" placeholder="–ë">
      <input id="pF" type="number" step="0.1" placeholder="–ñ">
      <input id="pC" type="number" step="0.1" placeholder="–£">
      <button id="prodAdd" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="small" style="margin-top:8px">
      –ü—Ä–∏–º–µ—Ä: <span class="mono">–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)</span> ‚Üí –ë=6 –ñ=5 –£=0.5
    </div>
    <div class="sep"></div>
    <div class="row small" id="prodHint"></div>
  </div>

  <div class="card">
    <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
    <div class="small">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ (—Å—ä–µ–ª / —Å–æ–∂–∂–µ–Ω–æ / –±–∞–ª–∞–Ω—Å / –≤–æ–¥–∞)</div>
    <ul class="list" id="histList"></ul>
  </div>
</div>

<script>
/*** helpers ***/
function localDateKey(d=new Date()){
  // YYYY-MM-DD –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function addDays(key, delta){
  const [y,m,d] = key.split('-').map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate()+delta);
  return localDateKey(dt);
}
function kcalFrom(p,f,c){ return p*4 + f*9 + c*4; }
function round1(x){ return Math.round(x*10)/10; }

/*** storage keys ***/
const KEY_FOODS = "bzu_foods_v3";
const KEY_DAYS  = "bzu_days_v3";
const KEY_VIEW  = "bzu_view_day_v3";

/*** default foods (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é) ***/
const DEFAULT_FOODS = [
  {name:"–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)", p:6, f:5, c:0.5},
  {name:"–Ø–±–ª–æ–∫–æ (1 —à—Ç)", p:0.5, f:0.3, c:25},
  {name:"–ë–∞–Ω–∞–Ω (1 —à—Ç)", p:1.3, f:0.4, c:27},
  {name:"–û—Ä–µ—Ö–∏ (30 –≥)", p:5, f:18, c:6}
];

/*** load ***/
let foods = JSON.parse(localStorage.getItem(KEY_FOODS) || "null");
if(!Array.isArray(foods) || foods.length===0){
  foods = DEFAULT_FOODS.slice();
  localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
}

let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "null");
if(!days || typeof days !== "object") days = {};

let viewDay = localStorage.getItem(KEY_VIEW) || localDateKey();
if(!days[viewDay]) days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };

function saveAll(){
  localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
  localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  localStorage.setItem(KEY_VIEW, viewDay);
}

/*** get day object ***/
function D(){
  if(!days[viewDay]) days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };
  return days[viewDay];
}

/*** UI refs ***/
const uiDate = document.getElementById("uiDate");
const uiInK  = document.getElementById("uiInK");
const uiBurnK= document.getElementById("uiBurnK");
const uiNetK = document.getElementById("uiNetK");
const uiWaterMl = document.getElementById("uiWaterMl");
const uiP = document.getElementById("uiP");
const uiF = document.getElementById("uiF");
const uiC = document.getElementById("uiC");

const foodSel = document.getElementById("foodSel");
const qtyInp  = document.getElementById("qtyInp");
const logList = document.getElementById("logList");
const histList= document.getElementById("histList");

const burnInp = document.getElementById("burnInp");

/*** render ***/
function renderFoods(){
  foodSel.innerHTML = "";
  foods.forEach((f, i)=>{
    const o = document.createElement("option");
    o.value = String(i);
    o.textContent = f.name;
    foodSel.appendChild(o);
  });
  const hint = document.getElementById("prodHint");
  hint.textContent = `–í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${foods.length}`;
}

function renderTotals(){
  const d = D();
  let P=0,F=0,C=0,K=0;
  d.log.forEach(e=>{ P+=e.p; F+=e.f; C+=e.c; K+=e.k; });
  uiP.textContent = round1(P).toFixed(1);
  uiF.textContent = round1(F).toFixed(1);
  uiC.textContent = round1(C).toFixed(1);
  uiInK.textContent = String(Math.round(K));
  uiBurnK.textContent = String(d.burnedKcal || 0);
  uiNetK.textContent = String(Math.round(K - (d.burnedKcal||0)));
  uiWaterMl.textContent = String(d.waterMl || 0);
}

function renderLog(){
  const d = D();
  logList.innerHTML = "";
  if(d.log.length===0){
    const li = document.createElement("li");
    li.className="small";
    li.textContent="–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.";
    logList.appendChild(li);
    return;
  }
  d.log.slice().reverse().forEach((e, revIdx)=>{
    const idx = d.log.length - 1 - revIdx; // original index
    const li = document.createElement("li");
    li.className="item";
    li.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemName">${e.name} √ó ${e.qty}</div>
          <div class="itemMeta">${e.time} ¬∑ –ö–∫–∞–ª ${Math.round(e.k)} ¬∑ –ë ${round1(e.p)} –ñ ${round1(e.f)} –£ ${round1(e.c)}</div>
        </div>
        <div class="right">
          <button class="danger" data-del="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `;
    logList.appendChild(li);
  });

  logList.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.getAttribute("data-del"));
      const d = D();
      d.log.splice(idx,1);
      saveAll();
      renderAll();
    };
  });
}

function renderHistory(){
  // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
  histList.innerHTML = "";
  const keys = Object.keys(days).sort().reverse().slice(0, 14);
  if(keys.length===0){
    const li=document.createElement("li");
    li.className="small";
    li.textContent="–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç.";
    histList.appendChild(li);
    return;
  }
  keys.forEach(k=>{
    const d = days[k];
    let K=0;
    d.log.forEach(e=>K+=e.k);
    const burned = d.burnedKcal||0;
    const net = Math.round(K - burned);
    const li=document.createElement("li");
    li.className="item";
    li.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemName">üìÖ ${k}${k===viewDay ? " (–æ—Ç–∫—Ä—ã—Ç)" : ""}</div>
          <div class="itemMeta">–°—ä–µ–ª ${Math.round(K)} ¬∑ –°–æ–∂–∂–µ–Ω–æ ${burned} ¬∑ –ë–∞–ª–∞–Ω—Å ${net} ¬∑ –í–æ–¥–∞ ${d.waterMl||0} –º–ª</div>
        </div>
        <div class="right">
          <button data-open="${k}">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    `;
    histList.appendChild(li);
  });

  histList.querySelectorAll("button[data-open]").forEach(btn=>{
    btn.onclick = ()=>{
      viewDay = btn.getAttribute("data-open");
      if(!days[viewDay]) days[viewDay] = {log:[], waterMl:0, burnedKcal:0};
      saveAll();
      renderAll();
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });
}

function renderAll(){
  uiDate.textContent = viewDay;
  renderFoods();
  renderTotals();
  renderLog();
  renderHistory();
}

/*** actions ***/
document.getElementById("addMeal").onclick = ()=>{
  const f = foods[Number(foodSel.value)];
  const qty = Number(qtyInp.value);
  if(!f || !qty || qty<=0) return;

  const p = f.p * qty;
  const fat = f.f * qty;
  const c = f.c * qty;
  const k = kcalFrom(p, fat, c);

  const now = new Date();
  const time = now.toLocaleTimeString("ru-RU", {hour:"2-digit", minute:"2-digit"});
  D().log.push({name:f.name, qty: qty, time, p, f:fat, c, k});

  qtyInp.value = "";
  saveAll();
  renderAll();
};

document.querySelectorAll("button[data-w]").forEach(btn=>{
  btn.onclick = ()=>{
    const add = Number(btn.getAttribute("data-w"));
    const d = D();
    d.waterMl = (d.waterMl || 0) + add;
    saveAll();
    renderAll();
  };
});

document.getElementById("waterReset").onclick = ()=>{
  D().waterMl = 0;
  saveAll(); renderAll();
};

document.getElementById("burnAdd").onclick = ()=>{
  const val = Number(burnInp.value);
  if(!val || val<=0) return;
  D().burnedKcal = (D().burnedKcal || 0) + val;
  burnInp.value = "";
  saveAll(); renderAll();
};

document.getElementById("burnReset").onclick = ()=>{
  D().burnedKcal = 0;
  saveAll(); renderAll();
};

document.getElementById("prodAdd").onclick = ()=>{
  const name = document.getElementById("pName").value.trim();
  const p = Number(document.getElementById("pP").value);
  const f = Number(document.getElementById("pF").value);
  const c = Number(document.getElementById("pC").value);
  if(!name || !isFinite(p) || !isFinite(f) || !isFinite(c)) return;

  foods.push({name, p, f, c});
  document.getElementById("pName").value = "";
  document.getElementById("pP").value = "";
  document.getElementById("pF").value = "";
  document.getElementById("pC").value = "";
  saveAll(); renderAll();
};

document.getElementById("resetDay").onclick = ()=>{
  if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏, –≤–æ–¥—É –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å?")) return;
  days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };
  saveAll(); renderAll();
};

document.getElementById("prevDay").onclick = ()=>{
  viewDay = addDays(viewDay, -1);
  if(!days[viewDay]) days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };
  saveAll(); renderAll();
};

document.getElementById("nextDay").onclick = ()=>{
  viewDay = addDays(viewDay, +1);
  if(!days[viewDay]) days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };
  saveAll(); renderAll();
};

document.getElementById("todayBtn").onclick = ()=>{
  viewDay = localDateKey();
  if(!days[viewDay]) days[viewDay] = { log:[], waterMl:0, burnedKcal:0 };
  saveAll(); renderAll();
};

/*** init ***/
saveAll();
renderAll();
</script>
</body>
</html>
