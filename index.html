<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калории / БЖУ</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --text:#e8edf6; --mut:#8ea0b8;
      --acc:#4da3ff; --ok:#44d07b; --bad:#ff5a6a; --bd:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px 14px 88px} /* место снизу под историю */
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .date{font-weight:800;font-size:16px;line-height:1.2}
    .subdate{font-size:12px;color:var(--mut);font-weight:600;margin-top:2px}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;color:var(--mut);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .k{border:1px solid var(--bd);border-radius:12px;padding:10px}
    .k .v{font-size:18px;font-weight:900}
    .k .l{font-size:11px;color:var(--mut);margin-top:2px}
    .inp, select{width:100%;background:#0e1420;border:1px solid var(--bd);color:var(--text);
      border-radius:12px;padding:10px;font-size:14px;outline:none}
    .inp:focus, select:focus{border-color:rgba(77,163,255,.6)}
    .btn{background:#0e1420;border:1px solid var(--bd);color:var(--text);border-radius:12px;padding:10px 12px;
      font-weight:800;font-size:14px;cursor:pointer;white-space:nowrap}
    .btn:active{transform:translateY(1px)}
    .btn.acc{border-color:rgba(77,163,255,.7);background:rgba(77,163,255,.08)}
    .btn.ok{border-color:rgba(68,208,123,.7);background:rgba(68,208,123,.08)}
    .btn.bad{border-color:rgba(255,90,106,.7);background:rgba(255,90,106,.08)}
    .mini{font-size:12px;color:var(--mut)}
    .sectionTitle{display:flex;align-items:flex-end;justify-content:space-between;margin:0 0 8px 0}
    .sectionTitle h3{margin:0;font-size:14px}
    .list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:grid;
      grid-template-columns:1fr auto;gap:8px;align-items:center}
    .item .name{font-weight:900}
    .item .sub{font-size:12px;color:var(--mut);margin-top:2px}
    .item .actions{display:flex;gap:6px;justify-content:flex-end}
    .tag{font-size:11px;color:var(--mut);border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
    .rightCol{display:flex;flex-direction:column;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:11px;color:var(--mut);margin-top:6px}
    .sep{height:1px;background:var(--bd);margin:10px 0}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .historyBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(11,15,20,.9);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--bd);
      padding:10px;
    }
    .historyInner{max-width:860px;margin:0 auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .historyLabel{font-size:12px;color:var(--mut);font-weight:700}
    .historyDate{min-width:160px;max-width:220px}
    .tiny{font-size:11px;color:var(--mut)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="date" id="dateText">—</div>
      <div class="subdate" id="dayKeyText">—</div>
    </div>
    <div class="pill" id="saveState">сохранено</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="sectionTitle">
        <h3>Итоги дня</h3>
        <span class="tag" id="modeTag">сегодня</span>
      </div>

      <div class="kpi">
        <div class="k"><div class="v" id="kcal">0</div><div class="l">ккал</div></div>
        <div class="k"><div class="v" id="p">0</div><div class="l">Белки, г</div></div>
        <div class="k"><div class="v" id="f">0</div><div class="l">Жиры, г</div></div>
        <div class="k"><div class="v" id="c">0</div><div class="l">Углеводы, г</div></div>
      </div>

      <div class="sep"></div>

      <div class="two">
        <div>
          <div class="mini">Вес (кг)</div>
          <input class="inp" id="weight" type="number" inputmode="decimal" step="0.1" placeholder="например 82.4">
        </div>
        <div>
          <div class="mini">Вода (литры)</div>
          <input class="inp" id="water" type="number" inputmode="decimal" step="0.1" placeholder="например 2.3">
          <div class="quick">
            <button class="btn acc" type="button" data-water="0.15">+150 мл</button>
            <button class="btn acc" type="button" data-water="0.20">+200 мл</button>
            <button class="btn bad" type="button" id="waterClear">сброс</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">
        <h3>Добавить продукт</h3>
        <span class="tag" id="foodsCount">0</span>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input class="inp" id="foodSearch" placeholder="поиск по твоим продуктам..." />
      </div>

      <div class="row">
        <select id="foodSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1;min-width:200px">
          <div class="mini">Граммы</div>
          <input class="inp" id="grams" type="number" inputmode="numeric" step="1" value="100">
          <div class="quick">
            <button class="btn acc" type="button" data-g="150">150 г</button>
            <button class="btn acc" type="button" data-g="200">200 г</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
          <button class="btn ok" id="addBtn">в день</button>
          <button class="btn acc" id="customBtn">в базу</button>
          <button class="btn bad" id="deleteFromBaseBtn">удалить из базы</button>
        </div>
      </div>

      <div class="hint" id="selInfo">сначала добавь продукты в базу кнопкой “в базу”</div>

      <div class="list" id="list"></div>

      <div class="sep"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn bad" id="clearDay">очистить день</button>
        <button class="btn" id="exportBtn">экспорт</button>
      </div>
      <div class="hint">экспорт — копирует текст в буфер</div>
    </div>

    <!-- RIGHT -->
    <div class="rightCol">
      <div class="card">
        <div class="sectionTitle">
          <h3>Быстро</h3>
          <span class="mini">сохранение авто</span>
        </div>
        <div class="row">
          <button class="btn" id="copyTotals">скопировать итоги</button>
          <button class="btn bad" id="resetAll">сбросить всё</button>
        </div>
        <div class="hint">“сбросить всё” удалит дни и твою базу продуктов</div>
      </div>

      <div class="card">
        <div class="sectionTitle">
          <h3>Подсказка</h3>
          <span class="mini">история</span>
        </div>
        <div class="tiny">
          Внизу выбираешь дату — открывается тот день (без списка всех дней на экране).
        </div>
      </div>
    </div>
  </div>
</div>

<!-- НИЖНЯЯ ПАНЕЛЬ ИСТОРИИ -->
<div class="historyBar">
  <div class="historyInner">
    <span class="historyLabel">День:</span>
    <input class="inp historyDate" id="dayPicker" type="date" />
    <button class="btn" id="prevDay" type="button">◀</button>
    <button class="btn" id="nextDay" type="button">▶</button>
    <button class="btn acc" id="goToday" type="button">Сегодня</button>
    <span class="pill" id="dayHint">—</span>
  </div>
</div>

<script>
(() => {
  // ======= ПУСТАЯ БАЗА (только твои продукты) =======
  const DEFAULT_FOODS = []; // пусто
  const CUSTOM_FOODS_KEY = "kcal_tracker_custom_foods_v1";

  function loadCustomFoods(){
    try{
      const raw = localStorage.getItem(CUSTOM_FOODS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveCustomFoods(arr){
    localStorage.setItem(CUSTOM_FOODS_KEY, JSON.stringify(arr));
  }

  let FOODS = [...DEFAULT_FOODS, ...loadCustomFoods()];

  // ======= УТИЛИТЫ =======
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=0) => (Number.isFinite(n) ? n.toFixed(d) : "0");
  const isoToday = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  };
  const niceDateFromKey = (key) => {
    // key: YYYY-MM-DD
    const [y,m,d] = key.split("-").map(Number);
    const dt = new Date(y, (m||1)-1, d||1);
    return dt.toLocaleDateString("ru-RU", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
  };
  const clampKey = (key) => /^\d{4}-\d{2}-\d{2}$/.test(key) ? key : isoToday();
  const addDays = (key, delta) => {
    const [y,m,d] = key.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate()+delta);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    const dd = String(dt.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  };

  // ======= ХРАНЕНИЕ =======
  const KEY = "kcal_tracker_v1";
  const state = { days: {} };

  let currentKey = isoToday(); // какой день открыт в интерфейсе

  function ensureDay(key) {
    const k = clampKey(key);
    if(!state.days[k]) state.days[k] = { items: [], waterL: "", weight: "" };
    return k;
  }
  function dayObj() { return state.days[ensureDay(currentKey)]; }

  function load() {
    try{
      const raw = localStorage.getItem(KEY);
      if(raw){
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object") Object.assign(state, obj);
      }
    }catch(e){}
    ensureDay(currentKey);
    initHistoryUI();
    render();
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(state));
    flashSaved();
  }

  let saveTimer = null;
  function saveSoon() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(save, 120);
  }

  function flashSaved() {
    const el = $("saveState");
    el.textContent = "сохранено";
    el.style.borderColor = "rgba(68,208,123,.6)";
    el.style.color = "rgba(232,237,246,.9)";
    setTimeout(() => {
      el.style.borderColor = "var(--bd)";
      el.style.color = "var(--mut)";
    }, 500);
  }

  // ======= СЧЁТ =======
  function totals() {
    const items = dayObj().items;
    let kcal=0,p=0,f=0,c=0;
    for(const it of items){
      const g = Number(it.grams)||0;
      const mul = g/100;
      kcal += (it.per100.kcal||0)*mul;
      p    += (it.per100.p||0)*mul;
      f    += (it.per100.f||0)*mul;
      c    += (it.per100.c||0)*mul;
    }
    return {kcal,p,f,c};
  }
  function setKpis() {
    const t = totals();
    $("kcal").textContent = Math.round(t.kcal);
    $("p").textContent    = fmt(t.p,1);
    $("f").textContent    = fmt(t.f,1);
    $("c").textContent    = fmt(t.c,1);
  }

  // ======= UI: продукты =======
  const foodSelect = $("foodSelect");
  const foodSearch = $("foodSearch");
  const gramsInp = $("grams");
  const selInfo = $("selInfo");
  const listEl = $("list");
  const foodsCount = $("foodsCount");

  function rebuildSelect(filter="") {
    const f = filter.trim().toLowerCase();
    foodSelect.innerHTML = "";

    const filtered = FOODS
      .slice()
      .sort((a,b) => a.name.localeCompare(b.name, "ru"))
      .filter(x => !f || x.name.toLowerCase().includes(f));

    for(const x of filtered){
      const opt = document.createElement("option");
      opt.value = x.name;
      opt.textContent = x.name;
      foodSelect.appendChild(opt);
    }

    foodsCount.textContent = String(filtered.length);

    if(filtered.length){
      foodSelect.value = filtered[0].name;
      updateSelInfo();
    } else {
      selInfo.textContent = "база пустая — нажми “в базу” и создай свои продукты";
    }
  }

  function getFoodByName(name){
    return FOODS.find(x => x.name === name);
  }
  function updateSelInfo() {
    const f = getFoodByName(foodSelect.value);
    if(!f){ return; }
    selInfo.textContent = `на 100г: ${f.kcal} ккал • Б ${f.p} • Ж ${f.f} • У ${f.c}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addFoodToDay(name, grams, per100){
    dayObj().items.unshift({ name, grams, per100 });
    saveSoon();
    render();
  }

  function renderList() {
    const items = dayObj().items;
    listEl.innerHTML = "";
    if(!items.length){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "список пуст";
      empty.style.padding = "6px 2px";
      listEl.appendChild(empty);
      return;
    }

    items.forEach((it, idx) => {
      const tK = (it.per100.kcal * it.grams/100);
      const tP = (it.per100.p * it.grams/100);
      const tF = (it.per100.f * it.grams/100);
      const tC = (it.per100.c * it.grams/100);

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="sub">${it.grams} г • ${Math.round(tK)} ккал • Б ${fmt(tP,1)} Ж ${fmt(tF,1)} У ${fmt(tC,1)}</div>
        </div>
        <div class="actions">
          <button class="btn" data-act="edit" data-i="${idx}">ред.</button>
          <button class="btn bad" data-act="del" data-i="${idx}">×</button>
        </div>
      `;
      listEl.appendChild(row);
    });
  }

  function renderHeader() {
    const isToday = (currentKey === isoToday());
    $("modeTag").textContent = isToday ? "сегодня" : "история";
    $("dateText").textContent = niceDateFromKey(currentKey);
    $("dayKeyText").textContent = currentKey;
    $("dayHint").textContent = isToday ? "открыт сегодня" : "открыта история";
  }

  function render() {
    ensureDay(currentKey);
    renderHeader();

    const d = dayObj();
    $("weight").value = d.weight ?? "";
    $("water").value  = d.waterL ?? "";

    setKpis();
    renderList();
  }

  // ======= ИСТОРИЯ (НИЖНЯЯ ПАНЕЛЬ) =======
  function initHistoryUI(){
    const dp = $("dayPicker");
    dp.value = currentKey;

    dp.addEventListener("change", () => {
      const k = clampKey(dp.value);
      openDay(k);
    });

    $("goToday").addEventListener("click", () => openDay(isoToday()));
    $("prevDay").addEventListener("click", () => openDay(addDays(currentKey, -1)));
    $("nextDay").addEventListener("click", () => openDay(addDays(currentKey,  1)));
  }

  function openDay(key){
    currentKey = clampKey(key);
    $("dayPicker").value = currentKey;
    ensureDay(currentKey);
    render();
  }

  // ======= ДЕЙСТВИЯ =======

  // Быстрые кнопки граммов
  document.querySelectorAll("[data-g]").forEach(btn => {
    btn.addEventListener("click", () => {
      gramsInp.value = String(btn.dataset.g);
      gramsInp.focus();
    });
  });

  // Быстрые кнопки воды (+150/+200 мл)
  document.querySelectorAll("[data-water]").forEach(btn => {
    btn.addEventListener("click", () => {
      const add = Number(btn.dataset.water) || 0;
      const cur = Number(dayObj().waterL) || 0;
      const next = Math.round((cur + add) * 100) / 100;
      dayObj().waterL = next;
      $("water").value = String(next);
      saveSoon();
    });
  });

  $("waterClear").addEventListener("click", () => {
    dayObj().waterL = "";
    $("water").value = "";
    saveSoon();
  });

  // Добавить выбранный продукт в день
  $("addBtn").addEventListener("click", () => {
    if(!FOODS.length){
      alert("Сначала добавь продукты в базу кнопкой “в базу”.");
      return;
    }
    const name = foodSelect.value;
    const g = Math.max(1, Math.round(Number(gramsInp.value)||0));
    const f = getFoodByName(name);
    if(!f) return;
    addFoodToDay(f.name, g, {kcal:f.kcal, p:f.p, f:f.f, c:f.c});
  });

  // Добавить новый продукт в базу
  $("customBtn").addEventListener("click", () => {
    const name = (prompt("Название продукта:") || "").trim();
    if(!name) return;

    const kcal = Number(prompt("Ккал на 100г:", "0")) || 0;
    const p = Number(prompt("Белки на 100г:", "0")) || 0;
    const f = Number(prompt("Жиры на 100г:", "0")) || 0;
    const c = Number(prompt("Углеводы на 100г:", "0")) || 0;

    const exists = FOODS.some(x => x.name.toLowerCase() === name.toLowerCase());
    if(!exists){
      const custom = loadCustomFoods();
      custom.push({name, kcal, p, f, c});
      saveCustomFoods(custom);
      FOODS = [...DEFAULT_FOODS, ...custom];
      rebuildSelect($("foodSearch").value);
      foodSelect.value = name;
      updateSelInfo();
    }

    const g = Math.max(1, Math.round(Number(gramsInp.value)||100));
    addFoodToDay(name, g, {kcal, p, f, c});
  });

  // Удалить продукт из базы (навсегда)
  $("deleteFromBaseBtn").addEventListener("click", () => {
    if(!FOODS.length){
      alert("База пустая.");
      return;
    }
    const name = foodSelect.value;
    if(!name) return;
    if(!confirm(`Удалить из базы: "${name}"?`)) return;

    const custom = loadCustomFoods();
    const idx = custom.findIndex(x => (x.name||"").toLowerCase() === name.toLowerCase());
    if(idx >= 0){
      custom.splice(idx, 1);
      saveCustomFoods(custom);
    }

    FOODS = [...DEFAULT_FOODS, ...loadCustomFoods()];
    rebuildSelect($("foodSearch").value);
    saveSoon();
  });

  foodSelect.addEventListener("change", updateSelInfo);
  foodSearch.addEventListener("input", (e) => rebuildSelect(e.target.value));

  // Редактирование / удаление в списке дня
  listEl.addEventListener("click", (e) => {
    const b = e.target.closest("button");
    if(!b) return;
    const act = b.dataset.act;
    const i = Number(b.dataset.i);
    const items = dayObj().items;
    if(!Number.isInteger(i) || i<0 || i>=items.length) return;

    if(act === "del"){
      items.splice(i,1);
      saveSoon();
      render();
    }
    if(act === "edit"){
      const it = items[i];
      const newG = prompt("Граммы:", String(it.grams));
      if(newG === null) return;
      const g = Math.max(1, Math.round(Number(newG)||it.grams));
      it.grams = g;
      saveSoon();
      render();
    }
  });

  // Вес / вода (вводом)
  $("weight").addEventListener("input", (e) => { dayObj().weight = e.target.value; saveSoon(); });
  $("water").addEventListener("input", (e)  => { dayObj().waterL = e.target.value; saveSoon(); });

  // Очистить текущий открытый день
  $("clearDay").addEventListener("click", () => {
    if(!confirm("Очистить этот день (список, воду и вес)?")) return;
    state.days[currentKey] = { items: [], waterL: "", weight: "" };
    saveSoon();
    render();
  });

  // Экспорт текущего дня
  $("exportBtn").addEventListener("click", async () => {
    const t = totals();
    const k = currentKey;
    const d = dayObj();
    const w = d.weight ? `Вес: ${d.weight} кг\n` : "";
    const water = d.waterL ? `Вода: ${d.waterL} л\n` : "";
    const header = `Дата: ${k}\n${w}${water}Итого: ${Math.round(t.kcal)} ккал • Б ${fmt(t.p,1)} Ж ${fmt(t.f,1)} У ${fmt(t.c,1)}\n\n`;
    const lines = d.items.slice().reverse().map(it => `- ${it.name} — ${it.grams} г`).join("\n");
    const text = header + (lines || "Список пуст");
    try{
      await navigator.clipboard.writeText(text);
      alert("Скопировано в буфер обмена");
    }catch(e){
      prompt("Скопируй вручную:", text);
    }
  });

  // Копировать итоги текущего дня
  $("copyTotals").addEventListener("click", async () => {
    const t = totals();
    const d = dayObj();
    const water = d.waterL ? ` • вода ${d.waterL}л` : "";
    const weight = d.weight ? ` • вес ${d.weight}кг` : "";
    const text = `${currentKey} • ${Math.round(t.kcal)} ккал • Б ${fmt(t.p,1)} Ж ${fmt(t.f,1)} У ${fmt(t.c,1)}${water}${weight}`;
    try{
      await navigator.clipboard.writeText(text);
      alert("Итоги скопированы");
    }catch(e){
      prompt("Скопируй вручную:", text);
    }
  });

  // Сбросить всё
  $("resetAll").addEventListener("click", () => {
    if(!confirm("Точно удалить все данные (все дни и твою базу продуктов)?")) return;
    localStorage.removeItem(KEY);
    localStorage.removeItem(CUSTOM_FOODS_KEY);
    location.reload();
  });

  // INIT
  rebuildSelect("");
  load();
})();
</script>
</body>
</html>
