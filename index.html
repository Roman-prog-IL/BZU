<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калории / БЖУ</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --text:#e8edf6; --mut:#8ea0b8;
      --acc:#4da3ff; --ok:#44d07b; --bad:#ff5a6a; --bd:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:860px;margin:0 auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .date{font-weight:700;font-size:18px}
    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;color:var(--mut);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:780px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .k{border:1px solid var(--bd);border-radius:12px;padding:10px}
    .k .v{font-size:18px;font-weight:800}
    .k .l{font-size:11px;color:var(--mut);margin-top:2px}
    .inp, select{width:100%;background:#0e1420;border:1px solid var(--bd);color:var(--text);
      border-radius:12px;padding:10px;font-size:14px;outline:none}
    .inp:focus, select:focus{border-color:rgba(77,163,255,.6)}
    .btn{background:#0e1420;border:1px solid var(--bd);color:var(--text);border-radius:12px;padding:10px 12px;
      font-weight:700;font-size:14px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.acc{border-color:rgba(77,163,255,.7);background:rgba(77,163,255,.08)}
    .btn.ok{border-color:rgba(68,208,123,.7);background:rgba(68,208,123,.08)}
    .btn.bad{border-color:rgba(255,90,106,.7);background:rgba(255,90,106,.08)}
    .mini{font-size:12px;color:var(--mut)}
    .sectionTitle{display:flex;align-items:flex-end;justify-content:space-between;margin:0 0 8px 0}
    .sectionTitle h3{margin:0;font-size:14px}
    .list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:grid;
      grid-template-columns:1fr auto;gap:8px;align-items:center}
    .item .name{font-weight:800}
    .item .sub{font-size:12px;color:var(--mut);margin-top:2px}
    .item .actions{display:flex;gap:6px;justify-content:flex-end}
    .tag{font-size:11px;color:var(--mut);border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
    .waterBox{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .waterBtns{display:flex;gap:8px;flex-wrap:wrap}
    .rightCol{display:flex;flex-direction:column;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:11px;color:var(--mut);margin-top:6px}
    .sep{height:1px;background:var(--bd);margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="date" id="dateText">—</div>
    <div class="pill" id="saveState">сохранено</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="sectionTitle">
        <h3>Сегодня</h3>
        <span class="mini" id="dayKeyText"></span>
      </div>

      <div class="kpi">
        <div class="k">
          <div class="v" id="kcal">0</div>
          <div class="l">ккал</div>
        </div>
        <div class="k">
          <div class="v" id="p">0</div>
          <div class="l">Белки, г</div>
        </div>
        <div class="k">
          <div class="v" id="f">0</div>
          <div class="l">Жиры, г</div>
        </div>
        <div class="k">
          <div class="v" id="c">0</div>
          <div class="l">Углеводы, г</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="two">
        <div>
          <div class="mini">Вес сегодня (кг)</div>
          <input class="inp" id="weight" type="number" inputmode="decimal" step="0.1" placeholder="например 82.4">
        </div>
        <div>
          <div class="mini">Вода (литры)</div>
          <div class="waterBox">
            <div>
              <div style="font-size:22px;font-weight:900" id="waterLiters">0.0</div>
              <div class="mini">за день</div>
            </div>
            <div class="waterBtns">
              <button class="btn acc" data-w="0.25">+250</button>
              <button class="btn acc" data-w="0.33">+330</button>
              <button class="btn acc" data-w="0.5">+500</button>
              <button class="btn bad" id="waterReset">сброс</button>
            </div>
          </div>
          <div class="hint">кнопки добавляют воду, всё сохраняется</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">
        <h3>Добавить продукт</h3>
        <span class="tag" id="foodsCount">0</span>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input class="inp" id="foodSearch" placeholder="поиск: яйцо, курица, творог..." />
      </div>

      <div class="row">
        <select id="foodSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1;min-width:160px">
          <div class="mini">Граммы</div>
          <input class="inp" id="grams" type="number" inputmode="numeric" step="1" value="100">
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn ok" id="addBtn">добавить</button>
          <button class="btn" id="customBtn">свой</button>
        </div>
      </div>

      <div class="hint" id="selInfo">—</div>

      <div class="list" id="list"></div>

      <div class="sep"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn bad" id="clearDay">очистить день</button>
        <button class="btn" id="exportBtn">экспорт</button>
      </div>
      <div class="hint">экспорт — копирует текст в буфер (можно вставить в чат/заметки)</div>
    </div>

    <!-- RIGHT -->
    <div class="rightCol">
      <div class="card">
        <div class="sectionTitle">
          <h3>Цели (необязательно)</h3>
          <span class="mini">для контроля</span>
        </div>
        <div class="two">
          <div>
            <div class="mini">Ккал цель</div>
            <input class="inp" id="goalKcal" type="number" step="1" placeholder="например 1600">
          </div>
          <div>
            <div class="mini">Вода цель (л)</div>
            <input class="inp" id="goalWater" type="number" step="0.1" placeholder="например 2.5">
          </div>
        </div>
        <div class="two" style="margin-top:10px">
          <div>
            <div class="mini">Белки цель (г)</div>
            <input class="inp" id="goalP" type="number" step="1" placeholder="например 140">
          </div>
          <div>
            <div class="mini">Жиры цель (г)</div>
            <input class="inp" id="goalF" type="number" step="1" placeholder="например 60">
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="mini">Углеводы цель (г)</div>
          <input class="inp" id="goalC" type="number" step="1" placeholder="например 120">
        </div>
        <div class="hint">если цели пустые — просто считаем факт за день</div>
      </div>

      <div class="card">
        <div class="sectionTitle">
          <h3>Быстро</h3>
          <span class="mini">сохранение авто</span>
        </div>
        <div class="row">
          <button class="btn" id="copyTotals">скопировать итоги</button>
          <button class="btn bad" id="resetAll">сбросить всё</button>
        </div>
        <div class="hint">“сбросить всё” удалит данные и по дням тоже</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ======= ПРОДУКТЫ (на 100г) =======
  const DEFAULT_FOODS = [
    ["Творог 5%",          121, 17.0, 5.0, 3.0],
    ["Творог 0-1%",         80, 18.0, 1.0, 3.0],
    ["Яйцо варёное",       155, 13.0,11.0, 1.1],
    ["Куриная грудка",     165, 31.0, 3.6, 0.0],
    ["Говядина постная",   187, 26.0, 9.0, 0.0],
    ["Тунец (в воде)",     116, 26.0, 1.0, 0.0],
    ["Йогурт натуральный",  60,  4.0, 3.0, 5.0],
    ["Овсянка сухая",      370, 13.0, 7.0, 62.0],
    ["Рис варёный",        130,  2.7,0.3, 28.0],
    ["Гречка варёная",     110,  3.6,1.1, 20.0],
    ["Картофель варёный",   77,  2.0,0.1, 17.0],
    ["Огурец",              15,  0.7,0.1, 3.6],
    ["Помидор",             18,  0.9,0.2, 3.9],
    ["Морковь",             41,  0.9,0.2, 9.6],
    ["Яблоко",              52,  0.3,0.2, 14.0],
    ["Мандарин",            53,  0.8,0.3, 13.0],
    ["Банан",               89,  1.1,0.3, 23.0],
    ["Тхина (паста)",      595, 17.0,53.0, 12.0],
    ["Орехи (смесь)",      610, 15.0,55.0, 16.0],
    ["Хлеб",               250,  8.0,3.0, 49.0],
  ].map(([name,kcal,p,f,c]) => ({name,kcal,p,f,c}));

  const CUSTOM_FOODS_KEY = "kcal_tracker_custom_foods_v1";

  function loadCustomFoods(){
    try{
      const raw = localStorage.getItem(CUSTOM_FOODS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveCustomFoods(arr){
    localStorage.setItem(CUSTOM_FOODS_KEY, JSON.stringify(arr));
  }

  let FOODS = [...DEFAULT_FOODS, ...loadCustomFoods()];

  // ======= УТИЛИТЫ =======
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=0) => (Number.isFinite(n) ? n.toFixed(d) : "0");
  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  };
  const niceDate = () => {
    const d = new Date();
    const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
    return d.toLocaleDateString("ru-RU", opts);
  };

  // ======= ХРАНЕНИЕ ДНЕЙ =======
  const KEY = "kcal_tracker_v1";
  const state = {
    days: {}, // dayKey: { items: [{name, grams, per100:{kcal,p,f,c}}], waterL, weight }
    goals: {kcal:"", water:"", p:"", f:"", c:""}
  };

  function load() {
    try{
      const raw = localStorage.getItem(KEY);
      if(raw){
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object") Object.assign(state, obj);
      }
    }catch(e){}
    ensureDay();
    renderGoalsInputs();
    render();
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(state));
    flashSaved();
  }

  let saveTimer = null;
  function saveSoon() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(save, 120);
  }

  function flashSaved() {
    const el = $("saveState");
    el.textContent = "сохранено";
    el.style.borderColor = "rgba(68,208,123,.6)";
    el.style.color = "rgba(232,237,246,.9)";
    setTimeout(() => {
      el.style.borderColor = "var(--bd)";
      el.style.color = "var(--mut)";
    }, 500);
  }

  function ensureDay() {
    const k = todayKey();
    if(!state.days[k]) state.days[k] = { items: [], waterL: 0, weight: "" };
    return k;
  }

  function day() {
    return state.days[ensureDay()];
  }

  // ======= СЧЁТ =======
  function totals() {
    const items = day().items;
    let kcal=0,p=0,f=0,c=0;
    for(const it of items){
      const g = Number(it.grams)||0;
      const mul = g/100;
      kcal += (it.per100.kcal||0)*mul;
      p    += (it.per100.p||0)*mul;
      f    += (it.per100.f||0)*mul;
      c    += (it.per100.c||0)*mul;
    }
    return {kcal,p,f,c};
  }

  function setKpis() {
    const t = totals();
    $("kcal").textContent = Math.round(t.kcal);
    $("p").textContent    = fmt(t.p,1);
    $("f").textContent    = fmt(t.f,1);
    $("c").textContent    = fmt(t.c,1);
    $("waterLiters").textContent = fmt(day().waterL,1);
  }

  // ======= UI: продукты =======
  const foodSelect = $("foodSelect");
  const foodSearch = $("foodSearch");
  const gramsInp = $("grams");
  const selInfo = $("selInfo");
  const listEl = $("list");
  const foodsCount = $("foodsCount");

  function rebuildSelect(filter="") {
    const f = filter.trim().toLowerCase();
    foodSelect.innerHTML = "";
    const filtered = FOODS
      .slice()
      .sort((a,b) => a.name.localeCompare(b.name, "ru"))
      .filter(x => !f || x.name.toLowerCase().includes(f));

    for(const x of filtered){
      const opt = document.createElement("option");
      opt.value = x.name;
      opt.textContent = x.name;
      foodSelect.appendChild(opt);
    }
    foodsCount.textContent = String(filtered.length);
    if(filtered.length) foodSelect.value = filtered[0].name;
    updateSelInfo();
  }

  function getFoodByName(name){
    return FOODS.find(x => x.name === name);
  }

  function updateSelInfo() {
    const f = getFoodByName(foodSelect.value);
    if(!f){ selInfo.textContent = "—"; return; }
    selInfo.textContent = `на 100г: ${f.kcal} ккал • Б ${f.p} • Ж ${f.f} • У ${f.c}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addFoodToDay(name, grams, per100){
    day().items.unshift({ name, grams, per100 });
    saveSoon();
    render();
  }

  function renderList() {
    const items = day().items;
    listEl.innerHTML = "";
    if(!items.length){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "список пуст";
      empty.style.padding = "6px 2px";
      listEl.appendChild(empty);
      return;
    }

    items.forEach((it, idx) => {
      const tK = (it.per100.kcal * it.grams/100);
      const tP = (it.per100.p * it.grams/100);
      const tF = (it.per100.f * it.grams/100);
      const tC = (it.per100.c * it.grams/100);

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="sub">${it.grams} г • ${Math.round(tK)} ккал • Б ${fmt(tP,1)} Ж ${fmt(tF,1)} У ${fmt(tC,1)}</div>
        </div>
        <div class="actions">
          <button class="btn" data-act="edit" data-i="${idx}">ред.</button>
          <button class="btn bad" data-act="del" data-i="${idx}">×</button>
        </div>
      `;
      listEl.appendChild(row);
    });
  }

  function render() {
    $("dateText").textContent = niceDate();
    $("dayKeyText").textContent = todayKey();
    $("weight").value = day().weight ?? "";
    setKpis();
    renderList();
  }

  // ======= ДЕЙСТВИЯ =======
  $("addBtn").addEventListener("click", () => {
    const name = foodSelect.value;
    const g = Math.max(1, Math.round(Number(gramsInp.value)||0));
    const f = getFoodByName(name);
    if(!f) return;
    addFoodToDay(f.name, g, {kcal:f.kcal, p:f.p, f:f.f, c:f.c});
  });

  // ВАЖНО: "СВОЙ" теперь сохраняется в базе и появляется в списке навсегда
  $("customBtn").addEventListener("click", () => {
    const name = (prompt("Название продукта:") || "").trim();
    if(!name) return;

    const kcal = Number(prompt("Ккал на 100г:", "0")) || 0;
    const p = Number(prompt("Белки на 100г:", "0")) || 0;
    const f = Number(prompt("Жиры на 100г:", "0")) || 0;
    const c = Number(prompt("Углеводы на 100г:", "0")) || 0;

    // если такого названия нет — добавляем в кастом
    const exists = FOODS.some(x => x.name.toLowerCase() === name.toLowerCase());
    if(!exists){
      const custom = loadCustomFoods();
      custom.push({name, kcal, p, f, c});
      saveCustomFoods(custom);

      FOODS = [...DEFAULT_FOODS, ...custom];
      rebuildSelect($("foodSearch").value);
      foodSelect.value = name;
      updateSelInfo();
    }

    const g = Math.max(1, Math.round(Number(gramsInp.value)||100));
    addFoodToDay(name, g, {kcal, p, f, c});
  });

  foodSelect.addEventListener("change", updateSelInfo);
  foodSearch.addEventListener("input", (e) => rebuildSelect(e.target.value));

  listEl.addEventListener("click", (e) => {
    const b = e.target.closest("button");
    if(!b) return;
    const act = b.dataset.act;
    const i = Number(b.dataset.i);
    const items = day().items;
    if(!Number.isInteger(i) || i<0 || i>=items.length) return;

    if(act === "del"){
      items.splice(i,1);
      saveSoon();
      render();
    }
    if(act === "edit"){
      const it = items[i];
      const newG = prompt("Граммы:", String(it.grams));
      if(newG === null) return;
      const g = Math.max(1, Math.round(Number(newG)||it.grams));
      it.grams = g;
      saveSoon();
      render();
    }
  });

  // Вес
  $("weight").addEventListener("input", (e) => {
    day().weight = e.target.value;
    saveSoon();
  });

  // Вода
  document.querySelectorAll("[data-w]").forEach(btn => {
    btn.addEventListener("click", () => {
      day().waterL = Math.max(0, (Number(day().waterL)||0) + Number(btn.dataset.w));
      saveSoon();
      render();
    });
  });
  $("waterReset").addEventListener("click", () => {
    day().waterL = 0;
    saveSoon();
    render();
  });

  // Очистить день
  $("clearDay").addEventListener("click", () => {
    if(!confirm("Очистить список, воду и вес за сегодня?")) return;
    state.days[todayKey()] = { items: [], waterL: 0, weight: "" };
    saveSoon();
    render();
  });

  // Экспорт
  $("exportBtn").addEventListener("click", async () => {
    const t = totals();
    const k = todayKey();
    const w = day().weight ? `Вес: ${day().weight} кг\n` : "";
    const water = `Вода: ${fmt(day().waterL,1)} л\n`;
    const header = `Дата: ${k}\n${w}${water}Итого: ${Math.round(t.kcal)} ккал • Б ${fmt(t.p,1)} Ж ${fmt(t.f,1)} У ${fmt(t.c,1)}\n\n`;
    const lines = day().items.slice().reverse().map(it => `- ${it.name} — ${it.grams} г`).join("\n");
    const text = header + (lines || "Список пуст");
    try{
      await navigator.clipboard.writeText(text);
      alert("Скопировано в буфер обмена");
    }catch(e){
      prompt("Скопируй вручную:", text);
    }
  });

  // Цели
  function renderGoalsInputs(){
    $("goalKcal").value  = state.goals.kcal ?? "";
    $("goalWater").value = state.goals.water ?? "";
    $("goalP").value     = state.goals.p ?? "";
    $("goalF").value     = state.goals.f ?? "";
    $("goalC").value     = state.goals.c ?? "";
  }
  ["goalKcal","goalWater","goalP","goalF","goalC"].forEach(id => {
    $(id).addEventListener("input", (e) => {
      const map = {goalKcal:"kcal", goalWater:"water", goalP:"p", goalF:"f", goalC:"c"};
      state.goals[map[id]] = e.target.value;
      saveSoon();
    });
  });

  // Копировать итоги
  $("copyTotals").addEventListener("click", async () => {
    const t = totals();
    const text = `${todayKey()} • ${Math.round(t.kcal)} ккал • Б ${fmt(t.p,1)} Ж ${fmt(t.f,1)} У ${fmt(t.c,1)} • вода ${fmt(day().waterL,1)}л` +
                 (day().weight ? ` • вес ${day().weight}кг` : "");
    try{
      await navigator.clipboard.writeText(text);
      alert("Итоги скопированы");
    }catch(e){
      prompt("Скопируй вручную:", text);
    }
  });

  // Сбросить всё
  $("resetAll").addEventListener("click", () => {
    if(!confirm("Точно удалить все данные (все дни и свои продукты тоже)?")) return;
    localStorage.removeItem(KEY);
    localStorage.removeItem(CUSTOM_FOODS_KEY);
    location.reload();
  });

  // INIT
  rebuildSelect("");
  load();
})();
</script>
</body>
</html>
