<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–ñ–£ + –í–æ–¥–∞ + –ò—Å—Ç–æ—Ä–∏—è</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --card2:#0f1117;
      --text:#e9eef7;
      --muted:#a7b0c2;
      --line:#243044;
      --blue:#2a6cf6;
      --red:#c63a3a;
      --green:#35c28a;
      --pill:#141a26;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif}
    a{color:inherit}
    header{
      position:sticky;top:0;z-index:5;
      background:linear-gradient(180deg, rgba(11,12,16,.98), rgba(11,12,16,.92));
      border-bottom:1px solid rgba(255,255,255,.04);
      padding:12px 14px;
      backdrop-filter: blur(10px);
    }
    .title{font-weight:700;font-size:16px;letter-spacing:.2px}
    .container{max-width:980px;margin:0 auto;padding:12px}
    .grid{
      display:grid;gap:12px;
      grid-template-columns: 1.25fr .75fr;
      align-items:start;
    }
    .card{
      background: radial-gradient(1200px 400px at 20% -10%, rgba(42,108,246,.14), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .sub{color:var(--muted);font-size:12px;line-height:1.3}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.nowrap{flex-wrap:nowrap}
    .spacer{height:8px}
    .pill{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:999px;
      padding:8px 10px;
      font-size:13px;
      display:flex;gap:8px;align-items:center;
      min-height:36px;
    }
    .pill b{font-weight:800}
    .kpi{
      display:grid;gap:10px;
      grid-template-columns: repeat(2, minmax(0,1fr));
      margin-top:8px;
    }
    .kpi .pill{justify-content:space-between}
    button{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    button.primary{background:linear-gradient(180deg, rgba(42,108,246,1), rgba(42,108,246,.82))}
    button.danger{background:linear-gradient(180deg, rgba(198,58,58,1), rgba(198,58,58,.82))}
    button:active{transform:translateY(1px)}
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder, textarea::placeholder{color:rgba(233,238,247,.35)}
    .mini{width:120px}
    .w160{width:160px}
    .w220{width:220px}
    .sep{height:1px;background:rgba(255,255,255,.07);margin:10px 0}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
    th,td{padding:10px 10px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{color:var(--muted);font-weight:700;background:rgba(255,255,255,.03);text-align:left}
    tr:last-child td{border-bottom:0}
    .right{display:flex;flex-direction:column;gap:12px}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .badgeOk{color:var(--green);font-weight:800}
    .badgeWarn{color:#ffd166;font-weight:800}
    .badgeBad{color:#ff6b6b;font-weight:800}

    /* –ò—Ç–æ–≥–∏ —á—É—Ç—å —à–∏—Ä–µ –∏ ‚Äú—Å–æ–±—Ä–∞–Ω–Ω–µ–µ‚Äù */
    .card.totals{padding:14px}
    .totals .row.topline .pill{flex:1 1 auto}

    /* mobile */
    @media (max-width: 820px){
      header{padding:10px 12px}
      .container{padding:10px}
      .grid{grid-template-columns:1fr}
      .row.nowrap{flex-wrap:wrap}
      .mini,.w160,.w220{width:100%}
      th:nth-child(3), td:nth-child(3), /* –ü–æ—Ä—Ü–∏–∏ */
      th:nth-child(5), td:nth-child(5), /* –ñ */
      th:nth-child(6), td:nth-child(6)  /* –£ */
      {display:none;}
    }
  </style>
</head>

<body>
<header>
  <div class="title">–ë–ñ–£ / –ü–æ—Ä—Ü–∏–∏ / –ò—Å—Ç–æ—Ä–∏—è (v5)</div>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT -->
    <div class="left">
      <!-- –î–µ–Ω—å -->
      <div class="card">
        <h2>–î–µ–Ω—å</h2>
        <div class="row nowrap">
          <button id="prevDayBtn">‚óÄ</button>
          <div class="pill" style="flex:1 1 auto;justify-content:center">
            <b id="dayLabel">‚Äî</b>
          </div>
          <button id="nextDayBtn">‚ñ∂</button>
          <button class="primary" id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="copyYesterdayBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞</button>
          <button class="danger" id="resetDayBtn">–°–±—Ä–æ—Å –¥–Ω—è</button>
        </div>
        <div class="small" style="margin-top:8px">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.</div>
      </div>

      <!-- –ò—Ç–æ–≥–∏ -->
      <div class="card totals">
        <h2>–ò—Ç–æ–≥–∏</h2>

        <div class="row topline">
          <div class="pill">üçΩÔ∏è –°—ä–µ–ª: <b id="uiEaten">0</b> –∫–∫–∞–ª</div>
          <div class="pill">üî• –°–æ–∂–∂–µ–Ω–æ: <b id="uiBurned">0</b> –∫–∫–∞–ª</div>
        </div>
        <div class="row topline">
          <div class="pill">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: <b id="uiBalance">0</b> –∫–∫–∞–ª</div>
          <div class="pill">üíß –í–æ–¥–∞: <b id="uiWater">0</b> –º–ª</div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="pill">–ë <b id="uiP">0.0</b> –≥</div>
          <div class="pill">–ñ <b id="uiF">0.0</b> –≥</div>
          <div class="pill">–£ <b id="uiC">0.0</b> –≥</div>
          <div class="pill">‚öñÔ∏è –í–µ—Å: <b id="uiWeight">‚Äî</b> –∫–≥</div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="pill">üéØ –¶–µ–ª—å –±–µ–ª–∫–∞: <b id="uiProteinGoal">140</b> –≥</div>
          <div class="pill">ü•© –û—Å—Ç–∞–ª–æ—Å—å –±–µ–ª–∫–∞: <b id="uiProteinLeft">0</b> –≥</div>
        </div>
        <div class="row">
          <div class="pill">üíß –¶–µ–ª—å –≤–æ–¥—ã: <b id="uiWaterGoal">2500</b> –º–ª</div>
          <div class="pill">üíß –û—Å—Ç–∞–ª–æ—Å—å –≤–æ–¥—ã: <b id="uiWaterLeft">0</b> –º–ª</div>
        </div>

        <div class="small" id="uiTip" style="margin-top:10px"></div>
      </div>

      <!-- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º: –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ + –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
      <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º</h2>
        <div class="row">
          <select id="foodSelect" class="w220">
            <option value="">–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç‚Ä¶</option>
          </select>
          <input id="portionInp" type="number" step="0.5" min="0" placeholder="–ø–æ—Ä—Ü–∏–∏" class="mini" />
          <button class="primary" id="addMealBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="small" style="margin-top:8px">
          –í—ã–±—Ä–∞–ª –ø—Ä–æ–¥—É–∫—Ç ‚Üí –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞–∂–∞—Ç—å ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª.  
          –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç –∏ –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª —Å –ø–æ—Ä—Ü–∏—è–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1).
        </div>

        <div class="sep"></div>

        <table>
          <thead>
            <tr>
              <th>–í—Ä–µ–º—è</th>
              <th>–ü—Ä–æ–¥—É–∫—Ç</th>
              <th>–ü–æ—Ä—Ü.</th>
              <th>–ö–∫–∞–ª</th>
              <th>–ñ</th>
              <th>–£</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>

      <!-- –ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é) -->
      <div class="card">
        <h2>–ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é)</h2>

        <div class="row">
          <input id="newName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –¢–≤–æ—Ä–æ–≥ 200 –≥)" />
        </div>
        <div class="spacer"></div>
        <div class="row">
          <input id="newK" type="number" step="1" min="0" placeholder="–ö–∫–∞–ª (–º–æ–∂–Ω–æ –ø—É—Å—Ç–æ)" class="mini"/>
          <input id="newP" type="number" step="0.1" min="0" placeholder="–ë" class="mini"/>
          <input id="newF" type="number" step="0.1" min="0" placeholder="–ñ" class="mini"/>
          <input id="newC" type="number" step="0.1" min="0" placeholder="–£" class="mini"/>
          <button class="primary" id="addFoodBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
        </div>

        <div class="small" style="margin-top:8px">
          –ï—Å–ª–∏ –ö–∫–∞–ª –ø—É—Å—Ç–æ ‚Äî –ø–æ—Å—á–∏—Ç–∞—é –ø–æ —Ñ–æ—Ä–º—É–ª–µ: –ë*4 + –£*4 + –ñ*9
        </div>

        <div class="sep"></div>

        <table>
          <thead>
            <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∫–∞–ª</th><th>–ë</th><th>–ñ</th><th>–£</th><th></th></tr>
          </thead>
          <tbody id="foodsBody"></tbody>
        </table>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <div class="card">
        <h2>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)</h2>
        <table>
          <thead>
            <tr><th>–î–∞—Ç–∞</th><th>–ö–∫–∞–ª</th><th>–ë–µ–ª–æ–∫</th><th>–í–æ–¥–∞</th><th>–í–µ—Å</th></tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
        <div class="small" style="margin-top:8px">–ù–∞–∂–º–∏ –Ω–∞ –¥–∞—Ç—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ—Ç –¥–µ–Ω—å.</div>
      </div>

      <!-- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è -->
      <div class="card">
        <h2>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h2>
        <div class="row">
          <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button class="danger" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
        </div>
        <div class="small" style="margin-top:8px">
          –≠–∫—Å–ø–æ—Ä—Ç ‚Äî —Å–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–º–µ—Ç–∫–∏. –ò–º–ø–æ—Ä—Ç ‚Äî –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ò–º–ø–æ—Ä—Ç¬ª.
        </div>
        <div class="spacer"></div>
        <textarea id="backupBox" rows="6" placeholder="–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —ç–∫—Å–ø–æ—Ä—Ç –∏–ª–∏ —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å –∏–º–ø–æ—Ä—Ç‚Ä¶"></textarea>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <!-- –í–æ–¥–∞ -->
      <div class="card">
        <h2>–í–æ–¥–∞</h2>
        <div class="row">
          <button id="w200">+200</button>
          <button id="w300">+300</button>
          <button id="w500">+500</button>
          <button id="wMinus200">-200</button>
        </div>
        <div class="spacer"></div>
        <button class="danger" id="wReset">–°–±—Ä–æ—Å</button>
      </div>

      <!-- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
      <div class="card">
        <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–∫–∫–∞–ª)</h2>
        <div class="row">
          <input id="burnInp" type="number" step="1" min="0" placeholder="–∫–∫–∞–ª" class="w160">
          <button class="primary" id="burnAddBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="spacer"></div>
        <button class="danger" id="burnResetBtn">–°–±—Ä–æ—Å</button>
      </div>

      <!-- –í–µ—Å -->
      <div class="card">
        <h2>–í–µ—Å (–∫–≥)</h2>
        <div class="row">
          <input id="weightInp" type="number" step="0.1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 73.0" class="w160">
          <button class="primary" id="weightSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="spacer"></div>
        <button class="danger" id="weightResetBtn">–°–±—Ä–æ—Å</button>
      </div>

      <!-- –¶–µ–ª–∏ -->
      <div class="card">
        <h2>–¶–µ–ª–∏</h2>
        <div class="row">
          <input id="goalProteinInp" type="number" step="1" min="0" placeholder="–ë–µ–ª–æ–∫ (–≥/–¥–µ–Ω—å)" class="w160">
          <input id="goalWaterInp" type="number" step="50" min="0" placeholder="–í–æ–¥–∞ (–º–ª/–¥–µ–Ω—å)" class="w160">
        </div>
        <div class="spacer"></div>
        <button class="primary" id="saveGoalsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="small" style="margin-top:8px" id="goalsHint"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== storage keys =====
  const KEY_FOODS = "bzu_foods_v5";
  const KEY_DAYS  = "bzu_days_v5";
  const KEY_GOALS = "bzu_goals_v5";
  const KEY_VIEW  = "bzu_viewday_v5";

  // ===== helpers =====
  const pad2 = n => String(n).padStart(2,"0");
  const todayKey = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseNum = (v, def=0) => {
    const x = Number(String(v).replace(",", "."));
    return Number.isFinite(x) ? x : def;
  };
  const round1 = x => Math.round(x*10)/10;
  const clamp0 = x => Math.max(0, x);

  function fmtDateRU(iso){
    const [y,m,d]=iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("ru-RU", {day:"2-digit", month:"short", year:"numeric"});
  }
  function nowTime(){
    const d=new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  // ===== data =====
  let foods = JSON.parse(localStorage.getItem(KEY_FOODS) || "null");
  if(!Array.isArray(foods) || foods.length===0){
    foods = [
      // –±–∞–∑–æ–≤—ã–µ –ø–æ—Ä—Ü–∏–∏
      {id:cryptoId(), name:"–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)", k:71, p:6.0, f:5.0, c:0.6},
      {id:cryptoId(), name:"–Ø–±–ª–æ–∫–æ (1 —à—Ç)", k:103, p:0.3, f:0.2, c:27.0},
      {id:cryptoId(), name:"–ë–∞–Ω–∞–Ω (1 —à—Ç)", k:117, p:1.3, f:0.4, c:30.0},
      {id:cryptoId(), name:"–û—Ä–µ—Ö–∏ (30 –≥)", k:206, p:5.0, f:18.0, c:6.0},
      // –ø–∞—Ä—É –ø–æ–ª–µ–∑–Ω—ã—Ö
      {id:cryptoId(), name:"–¢–≤–æ—Ä–æ–≥ (200 –≥)", k:226, p:28.0, f:10.0, c:8.0},
      {id:cryptoId(), name:"–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (150 –≥)", k:220, p:46.0, f:4.0, c:0.0},
      {id:cryptoId(), name:"–¢—É–Ω–µ—Ü (–±–∞–Ω–∫–∞ 120 –≥)", k:121, p:28.0, f:1.0, c:0.0},
      {id:cryptoId(), name:"–ô–æ–≥—É—Ä—Ç –≥—Ä–µ—á–µ—Å–∫–∏–π (200 –≥)", k:157, p:20.0, f:5.0, c:8.0},
    ];
    localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
  }

  let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "null");
  if(!days || typeof days!=="object") days = {};

  let goals = JSON.parse(localStorage.getItem(KEY_GOALS) || "null");
  if(!goals || typeof goals!=="object") goals = {protein:140, water:2500};

  let viewDay = localStorage.getItem(KEY_VIEW) || todayKey();

  function ensureDay(k){
    if(!days[k]) days[k] = { items:[], water:0, burned:0, weight:null };
    if(!Array.isArray(days[k].items)) days[k].items = [];
    if(!Number.isFinite(days[k].water)) days[k].water = 0;
    if(!Number.isFinite(days[k].burned)) days[k].burned = 0;
    return days[k];
  }

  function saveAll(){
    localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
    localStorage.setItem(KEY_DAYS, JSON.stringify(days));
    localStorage.setItem(KEY_GOALS, JSON.stringify(goals));
    localStorage.setItem(KEY_VIEW, viewDay);
  }

  function cryptoId(){
    // –ø—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è id –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // ===== UI refs =====
  const dayLabel = document.getElementById("dayLabel");
  const uiEaten = document.getElementById("uiEaten");
  const uiBurned = document.getElementById("uiBurned");
  const uiBalance = document.getElementById("uiBalance");
  const uiWater = document.getElementById("uiWater");
  const uiWeight = document.getElementById("uiWeight");
  const uiP = document.getElementById("uiP");
  const uiF = document.getElementById("uiF");
  const uiC = document.getElementById("uiC");
  const uiProteinGoal = document.getElementById("uiProteinGoal");
  const uiProteinLeft = document.getElementById("uiProteinLeft");
  const uiWaterGoal = document.getElementById("uiWaterGoal");
  const uiWaterLeft = document.getElementById("uiWaterLeft");
  const uiTip = document.getElementById("uiTip");

  const prevDayBtn = document.getElementById("prevDayBtn");
  const nextDayBtn = document.getElementById("nextDayBtn");
  const todayBtn = document.getElementById("todayBtn");
  const copyYesterdayBtn = document.getElementById("copyYesterdayBtn");
  const resetDayBtn = document.getElementById("resetDayBtn");

  const foodSelect = document.getElementById("foodSelect");
  const portionInp = document.getElementById("portionInp");
  const addMealBtn = document.getElementById("addMealBtn");

  const logBody = document.getElementById("logBody");
  const foodsBody = document.getElementById("foodsBody");
  const histBody = document.getElementById("histBody");

  const newName = document.getElementById("newName");
  const newK = document.getElementById("newK");
  const newP = document.getElementById("newP");
  const newF = document.getElementById("newF");
  const newC = document.getElementById("newC");
  const addFoodBtn = document.getElementById("addFoodBtn");

  const w200 = document.getElementById("w200");
  const w300 = document.getElementById("w300");
  const w500 = document.getElementById("w500");
  const wMinus200 = document.getElementById("wMinus200");
  const wReset = document.getElementById("wReset");

  const burnInp = document.getElementById("burnInp");
  const burnAddBtn = document.getElementById("burnAddBtn");
  const burnResetBtn = document.getElementById("burnResetBtn");

  const weightInp = document.getElementById("weightInp");
  const weightSaveBtn = document.getElementById("weightSaveBtn");
  const weightResetBtn = document.getElementById("weightResetBtn");

  const goalProteinInp = document.getElementById("goalProteinInp");
  const goalWaterInp = document.getElementById("goalWaterInp");
  const saveGoalsBtn = document.getElementById("saveGoalsBtn");
  const goalsHint = document.getElementById("goalsHint");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const backupBox = document.getElementById("backupBox");

  // ===== computations =====
  function totalsForDay(k){
    const d = ensureDay(k);
    let eatenK=0, P=0, F=0, C=0;
    for(const it of d.items){
      eatenK += it.k;
      P += it.p;
      F += it.f;
      C += it.c;
    }
    return {
      eatenK: Math.round(eatenK),
      burnedK: Math.round(d.burned || 0),
      balanceK: Math.round((eatenK - (d.burned||0))),
      water: Math.round(d.water||0),
      weight: (d.weight==null ? null : d.weight),
      P: round1(P),
      F: round1(F),
      C: round1(C),
    };
  }

  function proteinTip(leftP){
    if(leftP <= 0) return "‚úÖ –ë–µ–ª–æ–∫ –∑–∞–∫—Ä—ã—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.";
    // –¥–µ–ª–∞–µ–º –ø—Ä–∏—è—Ç–Ω—ã–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –±–µ–∑ –¥—Ä–æ–±–µ–π
    // –ø–æ–¥–±–∏—Ä–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Å–ø–∏—Å–∫–∞: –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –±–µ–ª–∫–æ–º/–∫–∫–∞–ª
    const candidates = foods
      .map(f=>({f, ratio: (f.p>0 ? f.p/(f.k||1) : 0)}))
      .sort((a,b)=>b.ratio-a.ratio)
      .slice(0,5)
      .map(x=>x.f);

    const best = candidates[0] || foods[0];
    const portions = Math.max(1, Math.round(leftP / Math.max(1, best.p)));
    return `üí° –ß—Ç–æ–±—ã –¥–æ–±—Ä–∞—Ç—å –±–µ–ª–æ–∫: –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ <b>${Math.ceil(leftP)}</b> –≥. –ü—Ä–∏–º–µ—Ä: <b>${portions}</b> –ø–æ—Ä—Ü. ¬´${best.name}¬ª.`;
  }

  // ===== render =====
  function renderDayHeader(){
    dayLabel.textContent = fmtDateRU(viewDay);
  }

  function renderFoodSelect(){
    const cur = foodSelect.value;
    foodSelect.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç‚Ä¶</option>` +
      foods.map(f=>`<option value="${f.id}">${escapeHtml(f.name)}</option>`).join("");
    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –µ—Å–ª–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω
    if(cur) foodSelect.value = cur;
  }

  function renderFoodsTable(){
    foodsBody.innerHTML = foods.map(f=>{
      return `
        <tr>
          <td>${escapeHtml(f.name)}</td>
          <td>${Math.round(f.k)}</td>
          <td>${round1(f.p).toFixed(1)}</td>
          <td>${round1(f.f).toFixed(1)}</td>
          <td>${round1(f.c).toFixed(1)}</td>
          <td><button class="danger" data-del-food="${f.id}">–£–¥–∞–ª–∏—Ç—å</button></td>
        </tr>
      `;
    }).join("");

    // delete handlers
    foodsBody.querySelectorAll("[data-del-food]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del-food");
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –±–∞–∑—ã?")) return;
        foods = foods.filter(x=>x.id!==id);

        // —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏–º –∏–∑ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π —ç–ª–µ–º–µ–Ω—Ç—ã —Å —ç—Ç–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º (–æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ ‚Äú–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π‚Äù –Ω–µ –Ω—É–∂–Ω–æ ‚Äî –ø—Ä–æ—â–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏)
        for(const k of Object.keys(days)){
          const d = ensureDay(k);
          d.items = d.items.filter(it=>it.foodId!==id);
        }
        saveAll();
        renderAll();
      };
    });
  }

  function renderLog(){
    const d = ensureDay(viewDay);
    logBody.innerHTML = d.items.map((it, idx)=>{
      return `
        <tr>
          <td>${escapeHtml(it.t)}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${round1(it.portions).toFixed(1)}</td>
          <td>${Math.round(it.k)}</td>
          <td>${round1(it.f).toFixed(1)}</td>
          <td>${round1(it.c).toFixed(1)}</td>
          <td><button class="danger" data-del="${idx}">–£–¥–∞–ª–∏—Ç—å</button></td>
        </tr>
      `;
    }).join("");

    logBody.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-del"));
        d.items.splice(i,1);
        saveAll();
        renderAll();
      };
    });
  }

  function renderHistory(){
    // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π –≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è, –ø–æ –∫–ª—é—á–∞–º –∏–ª–∏ –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
    const keys = [];
    const base = isoToDate(viewDay);
    for(let i=0;i<14;i++){
      const dt = new Date(base);
      dt.setDate(dt.getDate()-i);
      keys.push(todayKey(dt));
    }

    histBody.innerHTML = keys.map(k=>{
      const t = totalsForDay(k);
      return `
        <tr>
          <td>
            <button style="padding:8px 10px;border-radius:10px"
              data-open="${k}">${k}${k===viewDay?` <span class="muted">(–æ—Ç–∫—Ä—ã—Ç)</span>`:""}</button>
          </td>
          <td>${t.eatenK}</td>
          <td>${t.P.toFixed(1)}</td>
          <td>${t.water}</td>
          <td>${t.weight==null ? "‚Äî" : round1(t.weight).toFixed(1)}</td>
        </tr>
      `;
    }).join("");

    histBody.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = ()=>{
        viewDay = b.getAttribute("data-open");
        saveAll();
        renderAll();
        window.scrollTo({top:0, behavior:"smooth"});
      };
    });
  }

  function renderTotals(){
    const d = ensureDay(viewDay);
    const t = totalsForDay(viewDay);

    uiEaten.textContent = String(t.eatenK);
    uiBurned.textContent = String(t.burnedK);
    uiBalance.textContent = String(t.balanceK);
    uiWater.textContent = String(t.water);
    uiWeight.textContent = (t.weight==null ? "‚Äî" : round1(t.weight).toFixed(1));

    uiP.textContent = t.P.toFixed(1);
    uiF.textContent = t.F.toFixed(1);
    uiC.textContent = t.C.toFixed(1);

    const gp = Math.max(0, Math.round(goals.protein||0));
    const gw = Math.max(0, Math.round(goals.water||0));

    uiProteinGoal.textContent = String(gp);
    uiWaterGoal.textContent = String(gw);

    const leftP = gp>0 ? (gp - t.P) : 0;
    uiProteinLeft.textContent = gp>0
      ? (leftP>=0 ? String(Math.ceil(leftP)) : `–ø–µ—Ä–µ–±–æ—Ä +${Math.ceil(Math.abs(leftP))}`)
      : "‚Äî";

    const leftW = gw>0 ? (gw - t.water) : 0;
    uiWaterLeft.textContent = gw>0
      ? (leftW>=0 ? String(Math.ceil(leftW)) : `–ø–µ—Ä–µ–±–æ—Ä +${Math.ceil(Math.abs(leftW))}`)
      : "‚Äî";

    // –ø–æ–¥—Å–∫–∞–∑–∫–∞
    uiTip.innerHTML = proteinTip(gp>0 ? Math.max(0, gp - t.P) : 0);

    // –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤ —Ü–µ–ª—è—Ö
    goalsHint.textContent = `–°–µ–π—á–∞—Å: –±–µ–ª–æ–∫ ${gp} –≥, –≤–æ–¥–∞ ${gw} –º–ª.`;
  }

  function renderAll(){
    ensureDay(viewDay);
    renderDayHeader();
    renderFoodSelect();
    renderFoodsTable();
    renderLog();
    renderTotals();
    renderHistory();

    // –ø–æ–ª—è —Å–ø—Ä–∞–≤–∞
    goalProteinInp.value = String(Math.round(goals.protein||0));
    goalWaterInp.value = String(Math.round(goals.water||0));
  }

  // ===== actions =====
  function addMeal(foodId, portions){
    const d = ensureDay(viewDay);
    const f = foods.find(x=>x.id===foodId);
    if(!f) return;

    const p = Math.max(0.1, parseNum(portions, 1));
    const it = {
      t: nowTime(),
      foodId: f.id,
      name: f.name,
      portions: p,
      k: f.k * p,
      p: f.p * p,
      f: f.f * p,
      c: f.c * p
    };
    d.items.unshift(it);
    saveAll();
    renderAll();
  }

  function addWater(delta){
    const d = ensureDay(viewDay);
    d.water = clamp0((d.water||0) + delta);
    saveAll();
    renderAll();
  }

  // ===== events =====
  prevDayBtn.onclick = ()=>{
    const dt = isoToDate(viewDay);
    dt.setDate(dt.getDate()-1);
    viewDay = todayKey(dt);
    saveAll();
    renderAll();
  };
  nextDayBtn.onclick = ()=>{
    const dt = isoToDate(viewDay);
    dt.setDate(dt.getDate()+1);
    viewDay = todayKey(dt);
    saveAll();
    renderAll();
  };
  todayBtn.onclick = ()=>{
    viewDay = todayKey();
    saveAll();
    renderAll();
  };

  copyYesterdayBtn.onclick = ()=>{
    const dt = isoToDate(viewDay);
    dt.setDate(dt.getDate()-1);
    const yk = todayKey(dt);
    const y = ensureDay(yk);
    const d = ensureDay(viewDay);
    if(!confirm("–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –∏ –≤–æ–¥—É/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É/–≤–µ—Å —Å–æ –≤—á–µ—Ä–∞?")) return;

    d.items = JSON.parse(JSON.stringify(y.items || []));
    d.water = y.water||0;
    d.burned = y.burned||0;
    d.weight = (y.weight==null ? null : y.weight);
    saveAll();
    renderAll();
  };

  resetDayBtn.onclick = ()=>{
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å?")) return;
    days[viewDay] = { items:[], water:0, burned:0, weight:null };
    saveAll();
    renderAll();
  };

  // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º
  addMealBtn.onclick = ()=>{
    const id = foodSelect.value;
    if(!id){ alert("–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç"); return; }
    const p = portionInp.value ? parseNum(portionInp.value, 1) : 1;
    addMeal(id, p);
    portionInp.value = "";
    // –æ—Å—Ç–∞–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç ‚Äî —É–¥–æ–±–Ω–æ –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë
  };

  // –ß—Ç–æ–±—ã –±—ã–ª–æ ‚Äú–≤—ã–±—Ä–∞–ª –∏ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–∏–ª–æ—Å—å‚Äù:
  foodSelect.onchange = ()=>{
    const id = foodSelect.value;
    if(!id) return;
    const p = portionInp.value ? parseNum(portionInp.value, 1) : 1;
    addMeal(id, p);
    portionInp.value = "";
    foodSelect.value = ""; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ ‚Äú–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç‚Ä¶‚Äù
    renderFoodSelect();
  };

  // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
  addFoodBtn.onclick = ()=>{
    const name = newName.value.trim();
    if(!name){ alert("–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ"); return; }

    const p = parseNum(newP.value, 0);
    const f = parseNum(newF.value, 0);
    const c = parseNum(newC.value, 0);
    let k = parseNum(newK.value, NaN);
    if(!Number.isFinite(k) || k<=0){
      k = Math.round(p*4 + c*4 + f*9);
    }

    foods.unshift({id:cryptoId(), name, k, p, f, c});
    newName.value=""; newK.value=""; newP.value=""; newF.value=""; newC.value="";
    saveAll();
    renderAll();
  };

  // –í–æ–¥–∞ –∫–Ω–æ–ø–∫–∏
  w200.onclick = ()=>addWater(200);
  w300.onclick = ()=>addWater(300);
  w500.onclick = ()=>addWater(500);
  wMinus200.onclick = ()=>addWater(-200);
  wReset.onclick = ()=>{
    const d = ensureDay(viewDay);
    d.water = 0;
    saveAll(); renderAll();
  };

  // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
  burnAddBtn.onclick = ()=>{
    const d = ensureDay(viewDay);
    const add = parseNum(burnInp.value, 0);
    d.burned = clamp0((d.burned||0) + add);
    burnInp.value="";
    saveAll(); renderAll();
  };
  burnResetBtn.onclick = ()=>{
    const d = ensureDay(viewDay);
    d.burned = 0;
    saveAll(); renderAll();
  };

  // –í–µ—Å
  weightSaveBtn.onclick = ()=>{
    const d = ensureDay(viewDay);
    const w = parseNum(weightInp.value, NaN);
    if(!Number.isFinite(w) || w<=0){ alert("–í–≤–µ–¥–∏ –≤–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä 73.0)"); return; }
    d.weight = round1(w);
    weightInp.value="";
    saveAll(); renderAll();
  };
  weightResetBtn.onclick = ()=>{
    const d = ensureDay(viewDay);
    d.weight = null;
    saveAll(); renderAll();
  };

  // –¶–µ–ª–∏
  saveGoalsBtn.onclick = ()=>{
    const gp = parseNum(goalProteinInp.value, 0);
    const gw = parseNum(goalWaterInp.value, 0);
    goals.protein = Math.max(0, Math.round(gp));
    goals.water = Math.max(0, Math.round(gw));
    saveAll();
    renderAll();
  };

  // –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç
  exportBtn.onclick = ()=>{
    const payload = { foods, days, goals, v:5 };
    backupBox.value = JSON.stringify(payload);
  };

  importBtn.onclick = ()=>{
    const txt = backupBox.value.trim();
    if(!txt){ alert("–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞"); return; }
    try{
      const obj = JSON.parse(txt);
      if(!obj || typeof obj!=="object") throw new Error("bad");
      if(!Array.isArray(obj.foods) || typeof obj.days!=="object") throw new Error("bad");
      foods = obj.foods;
      days = obj.days;
      goals = obj.goals || goals;
      saveAll();
      renderAll();
      alert("–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤ ‚úÖ");
    }catch(e){
      alert("–ù–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–º–ø–æ—Ä—Ç. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å—Ç–∞–≤–∏–ª –≤–µ—Å—å —Ç–µ–∫—Å—Ç.");
    }
  };

  // utils
  function isoToDate(iso){
    const [y,m,d]=iso.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // init
  renderAll();
</script>
</body>
</html>
