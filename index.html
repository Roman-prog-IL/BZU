<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–ñ–£ / –ü–æ—Ä—Ü–∏–∏ / –ò—Å—Ç–æ—Ä–∏—è</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --card2:#0f1218;
      --line:#1e2430;
      --txt:#e8eefc;
      --muted:#9aa6c5;
      --accent:#2a6cf6;
      --danger:#d64545;
      --ok:#30c084;
      --pill:#0f1522;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% 10%, #101629 0%, rgba(16,22,41,0) 55%),
                  radial-gradient(900px 700px at 85% 25%, #0e1b2a 0%, rgba(14,27,42,0) 55%),
                  var(--bg);
      color:var(--txt);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
      font-weight:700;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      font-weight:650;
      letter-spacing:.2px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    input, select, textarea, button{
      font: inherit;
      color: var(--txt);
      background: rgba(0,0,0,.25);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    select, input[type="number"], input[type="text"]{ min-height: 42px; }
    textarea{ width:100%; min-height: 110px; resize: vertical; }

    button{
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.04);
    }
    button.primary{
      background: linear-gradient(180deg, rgba(42,108,246,.95), rgba(42,108,246,.75));
      border-color: rgba(42,108,246,.55);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(214,69,69,.95), rgba(214,69,69,.75));
      border-color: rgba(214,69,69,.55);
    }
    button.ghost{
      background: transparent;
    }
    button:active{ transform: translateY(1px); }

    .pill{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      padding: 8px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color: var(--txt);
    }
    .pill b{ font-weight:800; }

    .sep{
      height:1px;
      background: var(--line);
      margin: 10px 0;
      opacity:.85;
    }

    .muted{ color: var(--muted); }
    .small{ font-size:12px; color: var(--muted); }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      min-height: 56px;
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; font-weight:900; margin-top:2px; }
    .kpi .v span{ font-size:12px; font-weight:700; color:var(--muted); margin-left:6px; }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid var(--line);
      font-size: 13px;
      vertical-align: top;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      background: rgba(255,255,255,.02);
    }
    tr:last-child td{ border-bottom: 0; }
    td .xbtn{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      border: 1px solid rgba(214,69,69,.5);
      background: rgba(214,69,69,.15);
      color:#ffd2d2;
      white-space:nowrap;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quickGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }

    .totals.card{
      padding: 12px;
    }

    /* ===== Mobile: —Å–æ–±—Ä–∞—Ç—å –∏ —É–±—Ä–∞—Ç—å –ø—É—Å—Ç–æ—Ç—ã ===== */
    @media (max-width: 820px){
      .container{ padding: 10px; }
      .grid{ grid-template-columns: 1fr; }
      input[type="number"], input[type="text"], select{ width:100%; }
      .twoCol{ grid-template-columns: 1fr; }
      .quickGrid{ grid-template-columns: 1fr 1fr; }

      /* –ò—Ç–æ–≥–∏ ‚Äì —à–∏—Ä–µ (–ø–æ—á—Ç–∏ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω), –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ –≥–ª–∞–∑—É */
      .totals.card{
        margin-left: -10px;
        margin-right: -10px;
        border-radius: 14px;
      }

      /* –≤ –∂—É—Ä–Ω–∞–ª–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º "–ª–∏—à–Ω–µ–µ", —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—Ä–æ–±–∏/–∫–∞—à–∏ */
      table th:nth-child(5), table td:nth-child(5),
      table th:nth-child(6), table td:nth-child(6),
      table th:nth-child(7), table td:nth-child(7){
        display:none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>–ë–ñ–£ / –ü–æ—Ä—Ü–∏–∏ / –ò—Å—Ç–æ—Ä–∏—è (v5)</h1>
        <div class="sub">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–≤–æ—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ (LocalStorage). –ü–æ –¥–Ω—è–º ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ.</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="leftCol">
        <div class="card">
          <h3>–î–µ–Ω—å</h3>
          <div class="row">
            <button id="dayPrev" class="ghost">‚óÄ</button>
            <div class="pill"><b id="dayLabel">‚Äî</b></div>
            <button id="dayNext" class="ghost">‚ñ∂</button>
            <button id="dayToday" class="primary">–°–µ–≥–æ–¥–Ω—è</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="copyYesterday">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞</button>
            <button id="resetDay" class="danger">–°–±—Ä–æ—Å –¥–Ω—è</button>
          </div>
          <div class="small" style="margin-top:6px">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.</div>
        </div>

        <div class="card totals" style="margin-top:12px">
          <h3>–ò—Ç–æ–≥–∏</h3>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="t">üçΩÔ∏è –°—ä–µ–ª</div>
              <div class="v"><span id="uiEaten">0</span> <span>–∫–∫–∞–ª</span></div>
            </div>
            <div class="kpi">
              <div class="t">üî• –°–æ–∂–∂–µ–Ω–æ</div>
              <div class="v"><span id="uiBurned">0</span> <span>–∫–∫–∞–ª</span></div>
            </div>
            <div class="kpi">
              <div class="t">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å</div>
              <div class="v"><span id="uiBalance">0</span> <span>–∫–∫–∞–ª</span></div>
            </div>
            <div class="kpi">
              <div class="t">üíß –í–æ–¥–∞</div>
              <div class="v"><span id="uiWater">0</span> <span>–º–ª</span></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <span class="pill">ü•© –ë <b id="uiP">0.0</b> –≥</span>
            <span class="pill">üßà –ñ <b id="uiF">0.0</b> –≥</span>
            <span class="pill">üçû –£ <b id="uiC">0.0</b> –≥</span>
            <span class="pill">‚öñÔ∏è –í–µ—Å: <b id="uiW">‚Äî</b> –∫–≥</span>
          </div>

          <div class="sep"></div>

          <div class="row">
            <span class="pill">üéØ –¶–µ–ª—å –±–µ–ª–∫–∞: <b id="uiProteinGoal">0</b> –≥</span>
            <span class="pill">üìå –û—Å—Ç–∞–ª–æ—Å—å –±–µ–ª–∫–∞: <b id="uiProteinLeft">‚Äî</b></span>
            <span class="pill">üíß –¶–µ–ª—å –≤–æ–¥—ã: <b id="uiWaterGoal">0</b> –º–ª</span>
          </div>
          <div class="small" style="margin-top:8px" id="uiProteinHint">‚Äî</div>
        </div>

        <div class="twoCol" style="margin-top:12px">
          <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º</h3>
            <div class="row">
              <div style="flex:1">
                <label>–ü—Ä–æ–¥—É–∫—Ç</label>
                <select id="eatFood"></select>
              </div>
              <div style="width:140px">
                <label>–ü–æ—Ä—Ü–∏–∏</label>
                <input id="eatPortions" type="number" step="0.5" min="0" placeholder="1" />
              </div>
              <div style="width:140px;align-self:flex-end">
                <button id="eatAdd" class="primary" style="width:100%">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="sep"></div>
            <h3>–ë—ã—Å—Ç—Ä–æ (1 —Ç–∞–ø)</h3>
            <div class="quickGrid" id="quickBtns"></div>

            <div class="sep"></div>
            <h3>–ó–∞–ø–∏—Å–∏ –¥–Ω—è</h3>
            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th style="width:64px">–í—Ä–µ–º—è</th>
                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                    <th style="width:70px">–ü–æ—Ä—Ü.</th>
                    <th style="width:70px">–ö–∫–∞–ª</th>
                    <th style="width:70px">–ë</th>
                    <th style="width:70px">–ñ</th>
                    <th style="width:70px">–£</th>
                    <th style="width:86px"> </th>
                  </tr>
                </thead>
                <tbody id="entriesTbody"></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <h3>–í–æ–¥–∞</h3>
            <div class="row">
              <button class="pill" data-water="200">+200</button>
              <button class="pill" data-water="300">+300</button>
              <button class="pill" data-water="500">+500</button>
              <button class="pill" data-water="-200">‚àí200</button>
              <button id="waterReset" class="danger" style="width:100%">–°–±—Ä–æ—Å</button>
            </div>

            <div class="sep"></div>

            <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–∫–∫–∞–ª)</h3>
            <div class="row">
              <input id="burnInp" type="number" min="0" step="10" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 450" />
              <button id="burnAdd" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button id="burnReset" class="danger">–°–±—Ä–æ—Å</button>
            </div>

            <div class="sep"></div>

            <h3>–í–µ—Å (–∫–≥)</h3>
            <div class="row">
              <input id="weightInp" type="number" step="0.1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 73.0" />
              <button id="weightSave" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="weightClear" class="danger">–°–±—Ä–æ—Å</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>–ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é)</h3>
          <div class="row">
            <div style="flex:1">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="foodName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä –¢–≤–æ—Ä–æ–≥ (200 –≥)" />
            </div>
            <div style="width:110px">
              <label>–ë</label>
              <input id="foodP" type="number" step="0.1" min="0" placeholder="0" />
            </div>
            <div style="width:110px">
              <label>–ñ</label>
              <input id="foodF" type="number" step="0.1" min="0" placeholder="0" />
            </div>
            <div style="width:110px">
              <label>–£</label>
              <input id="foodC" type="number" step="0.1" min="0" placeholder="0" />
            </div>
            <div style="width:160px; align-self:flex-end">
              <button id="foodAdd" class="primary" style="width:100%">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
            </div>
          </div>

          <div class="small" style="margin-top:8px">
            –ü—Ä–∏–º–µ—Ä: <b>–û—Ä–µ—Ö–∏ (30 –≥)</b> –ë=5 –ñ=18 –£=6 ‚Äî —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è <b>–∑–∞ 1 –ø–æ—Ä—Ü–∏—é</b>.
          </div>

          <div class="sep"></div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th style="width:80px">–ö–∫–∞–ª</th>
                  <th style="width:80px">–ë</th>
                  <th style="width:80px">–ñ</th>
                  <th style="width:80px">–£</th>
                  <th style="width:90px"> </th>
                </tr>
              </thead>
              <tbody id="foodsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightCol">
        <div class="card">
          <h3>–¶–µ–ª–∏</h3>
          <div class="row">
            <div style="flex:1">
              <label>–ë–µ–ª–æ–∫ (–≥/–¥–µ–Ω—å)</label>
              <input id="goalProteinInp" type="number" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 140" />
            </div>
            <div style="flex:1">
              <label>–í–æ–¥–∞ (–º–ª/–¥–µ–Ω—å)</label>
              <input id="goalWaterInp" type="number" min="0" step="100" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 2500" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="saveGoals" class="primary" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div class="small" style="margin-top:8px">
            –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –±–µ–ª–æ–∫ <b>140 –≥</b>, –≤–æ–¥–∞ <b>2500 –º–ª</b>. –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)</h3>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">–î–∞—Ç–∞</th>
                  <th style="width:80px">–ö–∫–∞–ª</th>
                  <th style="width:90px">–ë–µ–ª–æ–∫</th>
                  <th style="width:80px">–í–æ–¥–∞</th>
                  <th style="width:80px">–í–µ—Å</th>
                </tr>
              </thead>
              <tbody id="histTbody"></tbody>
            </table>
          </div>
          <div class="small" style="margin-top:8px">
            –ù–∞–∂–º–∏ –Ω–∞ –¥–µ–Ω—å —Å–ª–µ–≤–∞ (—Å—Ç—Ä–µ–ª–∫–∏) —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è. –ò—Å—Ç–æ—Ä–∏—è –∑–¥–µ—Å—å ‚Äî –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç—Ä–µ–Ω–¥–∞.
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h3>
          <div class="row">
            <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="importBtn" class="danger">–ò–º–ø–æ—Ä—Ç</button>
          </div>
          <div class="small" style="margin-top:8px">
            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞—Å—Ç —Ç–µ–∫—Å—Ç. –°–∫–æ–ø–∏—Ä—É–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –≤ –∑–∞–º–µ—Ç–∫–∏. –ò–º–ø–æ—Ä—Ç ‚Äî –≤—Å—Ç–∞–≤—å –æ–±—Ä–∞—Ç–Ω–æ.
          </div>
          <div style="margin-top:10px">
            <textarea id="backupArea" placeholder="–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —ç–∫—Å–ø–æ—Ä—Ç –∏–ª–∏ —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å –∏–º–ø–æ—Ä—Ç..."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ========= Storage keys =========
  const KEY_FOODS = "bzu_foods_v5";
  const KEY_DAYS  = "bzu_days_v5";
  const KEY_VIEW  = "bzu_viewDay_v5";
  const KEY_GOALS = "bzu_goals_v5";

  // ========= Helpers =========
  const pad2 = (n)=> String(n).padStart(2,"0");
  const fmtDate = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtDateRu = (d)=> d.toLocaleDateString("ru-RU", { day:"2-digit", month:"short", year:"numeric" }).replace(".", "") + " –≥.";
  const nowTime = ()=> {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  };
  const round1 = (x)=> Math.round(x*10)/10;
  const kcalOf = (P,F,C)=> (P*4 + C*4 + F*9);

  function safeNum(v, def=0){
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }

  // ========= Default foods (per portion) =========
  const DEFAULT_FOODS = [
    { id: crypto.randomUUID(), name: "–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)", P: 6.0, F: 5.0, C: 0.6 },
    { id: crypto.randomUUID(), name: "–Ø–±–ª–æ–∫–æ (1 —à—Ç)",       P: 0.3, F: 0.2, C: 25.0 },
    { id: crypto.randomUUID(), name: "–ë–∞–Ω–∞–Ω (1 —à—Ç)",        P: 1.3, F: 0.4, C: 27.0 },
    { id: crypto.randomUUID(), name: "–û—Ä–µ—Ö–∏ (30 –≥)",        P: 5.0, F: 18.0, C: 6.0 },

    // –ø–æ–ª–µ–∑–Ω—ã–µ –¥–ª—è –¥–æ–±–æ—Ä–∞ –±–µ–ª–∫–∞ (–º–æ–∂–µ—à—å —É–¥–∞–ª–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å)
    { id: crypto.randomUUID(), name: "–¢–≤–æ—Ä–æ–≥ (200 –≥)",      P: 28.0, F: 10.0, C: 6.0 },
    { id: crypto.randomUUID(), name: "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (150 –≥)", P: 46.0, F: 4.0, C: 0.0 },
    { id: crypto.randomUUID(), name: "–¢—É–Ω–µ—Ü (–±–∞–Ω–∫–∞ 120 –≥)", P: 28.0, F: 1.0, C: 0.0 },
    { id: crypto.randomUUID(), name: "–ô–æ–≥—É—Ä—Ç –≥—Ä–µ—á–µ—Å–∫–∏–π (200 –≥)", P: 20.0, F: 5.0, C: 8.0 },
  ];

  // ========= State =========
  let foods = JSON.parse(localStorage.getItem(KEY_FOODS) || "null");
  if (!Array.isArray(foods) || foods.length === 0) foods = DEFAULT_FOODS;

  let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "null");
  if (!days || typeof days !== "object") days = {};

  let goals = JSON.parse(localStorage.getItem(KEY_GOALS) || "null");
  if (!goals || typeof goals !== "object") goals = { protein: 140, water: 2500 };

  let viewDay = localStorage.getItem(KEY_VIEW) || fmtDate(new Date());

  function ensureDay(key){
    if (!days[key]) {
      days[key] = {
        entries: [],       // {id, time, foodId, portions, P,F,C,kcal}
        waterMl: 0,
        burnedKcal: 0,
        weightKg: null
      };
    }
    if (!Array.isArray(days[key].entries)) days[key].entries = [];
    if (!Number.isFinite(days[key].waterMl)) days[key].waterMl = 0;
    if (!Number.isFinite(days[key].burnedKcal)) days[key].burnedKcal = 0;
    if (!("weightKg" in days[key])) days[key].weightKg = null;
    return days[key];
  }

  function saveAll(){
    localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
    localStorage.setItem(KEY_DAYS, JSON.stringify(days));
    localStorage.setItem(KEY_VIEW, viewDay);
    localStorage.setItem(KEY_GOALS, JSON.stringify(goals));
  }

  // ========= DOM =========
  const dayLabel = document.getElementById("dayLabel");
  const dayPrev = document.getElementById("dayPrev");
  const dayNext = document.getElementById("dayNext");
  const dayToday = document.getElementById("dayToday");
  const copyYesterday = document.getElementById("copyYesterday");
  const resetDay = document.getElementById("resetDay");

  const uiEaten = document.getElementById("uiEaten");
  const uiBurned = document.getElementById("uiBurned");
  const uiBalance = document.getElementById("uiBalance");
  const uiWater = document.getElementById("uiWater");
  const uiP = document.getElementById("uiP");
  const uiF = document.getElementById("uiF");
  const uiC = document.getElementById("uiC");
  const uiW = document.getElementById("uiW");

  const uiProteinGoal = document.getElementById("uiProteinGoal");
  const uiProteinLeft = document.getElementById("uiProteinLeft");
  const uiWaterGoal = document.getElementById("uiWaterGoal");
  const uiProteinHint = document.getElementById("uiProteinHint");

  const eatFood = document.getElementById("eatFood");
  const eatPortions = document.getElementById("eatPortions");
  const eatAdd = document.getElementById("eatAdd");
  const entriesTbody = document.getElementById("entriesTbody");
  const quickBtns = document.getElementById("quickBtns");

  const waterReset = document.getElementById("waterReset");
  const burnInp = document.getElementById("burnInp");
  const burnAdd = document.getElementById("burnAdd");
  const burnReset = document.getElementById("burnReset");

  const weightInp = document.getElementById("weightInp");
  const weightSave = document.getElementById("weightSave");
  const weightClear = document.getElementById("weightClear");

  const foodName = document.getElementById("foodName");
  const foodP = document.getElementById("foodP");
  const foodF = document.getElementById("foodF");
  const foodC = document.getElementById("foodC");
  const foodAdd = document.getElementById("foodAdd");
  const foodsTbody = document.getElementById("foodsTbody");

  const goalProteinInp = document.getElementById("goalProteinInp");
  const goalWaterInp = document.getElementById("goalWaterInp");
  const saveGoalsBtn = document.getElementById("saveGoals");

  const histTbody = document.getElementById("histTbody");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const backupArea = document.getElementById("backupArea");

  // ========= Rendering =========
  function getFoodById(id){
    return foods.find(f => f.id === id) || null;
  }

  function renderDayHeader(){
    const d = new Date(viewDay + "T00:00:00");
    dayLabel.textContent = fmtDateRu(d);
  }

  function computeTotals(day){
    let P=0,F=0,C=0,K=0;
    for (const e of day.entries){
      P += safeNum(e.P);
      F += safeNum(e.F);
      C += safeNum(e.C);
      K += safeNum(e.kcal);
    }
    return { P, F, C, K };
  }

  function proteinHint(leftP){
    const target = Math.max(0, leftP);
    if (target <= 0) return "‚úÖ –ë–µ–ª–æ–∫ –ø–æ —Ü–µ–ª–∏ –∑–∞–∫—Ä—ã—Ç. –û—Ç–ª–∏—á–Ω–æ!";

    // –ü–æ–¥–±–µ—Ä—ë–º 2‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å –≤—ã—Å–æ–∫–∏–º –±–µ–ª–∫–æ–º –Ω–∞ –ø–æ—Ä—Ü–∏—é
    const candidates = foods
      .map(f => ({...f, p: safeNum(f.P), kcal: kcalOf(safeNum(f.P), safeNum(f.F), safeNum(f.C))}))
      .filter(f => f.p >= 10)  // —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –±–µ–ª–∫–æ–≤—ã–µ
      .sort((a,b)=> b.p - a.p)
      .slice(0, 3);

    if (candidates.length === 0){
      return `–ß—Ç–æ–±—ã –¥–æ–±—Ä–∞—Ç—å –±–µ–ª–æ–∫: –Ω—É–∂–Ω–æ –µ—â—ë –ø—Ä–∏–º–µ—Ä–Ω–æ +${Math.ceil(target)} –≥. –î–æ–±–∞–≤—å –±–µ–ª–∫–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ —Å–ø–∏—Å–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–≤–æ—Ä–æ–≥/–∫—É—Ä–∏—Ü–∞/—Ç—É–Ω–µ—Ü).`;
    }

    const opts = candidates.map(f => {
      // –ø–æ—Ä—Ü–∏–∏ –æ–∫—Ä—É–≥–ª–∏–º –¥–æ 0.5, –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 6, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äú21 –ø–æ—Ä—Ü–∏—è‚Äù
      let portions = target / f.p;
      portions = Math.ceil(portions * 2) / 2;
      if (portions > 6) portions = 6;
      return `‚âà ${portions} –ø–æ—Ä—Ü. ${f.name}`;
    });

    return `–ß—Ç–æ–±—ã –¥–æ–±—Ä–∞—Ç—å –±–µ–ª–æ–∫: –Ω—É–∂–Ω–æ –µ—â—ë –ø—Ä–∏–º–µ—Ä–Ω–æ +${Math.ceil(target)} –≥. –ü—Ä–∏–º–µ—Ä—ã: ${opts.join(" –∏–ª–∏ ")}.`;
  }

  function renderTotals(){
    const day = ensureDay(viewDay);
    const t = computeTotals(day);

    const eaten = Math.round(t.K);
    const burned = Math.round(day.burnedKcal || 0);
    const balance = eaten - burned;

    uiEaten.textContent = String(eaten);
    uiBurned.textContent = String(burned);
    uiBalance.textContent = String(balance);
    uiWater.textContent = String(Math.round(day.waterMl || 0));

    uiP.textContent = round1(t.P).toFixed(1);
    uiF.textContent = round1(t.F).toFixed(1);
    uiC.textContent = round1(t.C).toFixed(1);

    uiW.textContent = (day.weightKg == null) ? "‚Äî" : Number(day.weightKg).toFixed(1);

    uiProteinGoal.textContent = String(Math.round(goals.protein || 0));
    uiWaterGoal.textContent = String(Math.round(goals.water || 0));

    const goalP = safeNum(goals.protein, 0);
    const leftP = goalP > 0 ? (goalP - t.P) : 0;

    if (goalP <= 0) uiProteinLeft.textContent = "‚Äî";
    else if (leftP >= 0) uiProteinLeft.textContent = `${Math.ceil(leftP)} –≥`;
    else uiProteinLeft.textContent = `–ø–µ—Ä–µ–±–æ—Ä +${Math.ceil(Math.abs(leftP))} –≥`;

    uiProteinHint.textContent = proteinHint(leftP);
  }

  function renderFoodsSelect(){
    eatFood.innerHTML = "";
    foods.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      eatFood.appendChild(opt);
    });
  }

  function renderQuickButtons(){
    // –±—ã—Å—Ç—Ä—ã–µ ‚Äî –ø–µ—Ä–≤—ã–µ 4 –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ—Ç–æ–º
    const defaults = [
      foods.find(f => f.name.includes("–Ø–π—Ü–æ"))?.id,
      foods.find(f => f.name.includes("–Ø–±–ª–æ–∫–æ"))?.id,
      foods.find(f => f.name.includes("–ë–∞–Ω–∞–Ω"))?.id,
      foods.find(f => f.name.includes("–û—Ä–µ—Ö–∏"))?.id,
    ].filter(Boolean);

    quickBtns.innerHTML = "";
    defaults.slice(0,4).forEach(id => {
      const f = getFoodById(id);
      if (!f) return;
      const b = document.createElement("button");
      b.textContent = `+1 ${f.name}`;
      b.onclick = () => addEntry(id, 1);
      quickBtns.appendChild(b);
    });
  }

  function renderEntries(){
    const day = ensureDay(viewDay);
    entriesTbody.innerHTML = "";
    for (const e of day.entries.slice().sort((a,b)=> (a.time > b.time ? -1 : 1))){
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = e.time || "‚Äî";

      const tdN = document.createElement("td");
      tdN.textContent = e.name || (getFoodById(e.foodId)?.name || "‚Äî");

      const tdPor = document.createElement("td");
      tdPor.textContent = String(e.portions ?? 1);

      const tdK = document.createElement("td");
      tdK.textContent = String(Math.round(e.kcal || 0));

      const tdP = document.createElement("td");
      tdP.textContent = round1(e.P||0).toFixed(1);

      const tdF = document.createElement("td");
      tdF.textContent = round1(e.F||0).toFixed(1);

      const tdC = document.createElement("td");
      tdC.textContent = round1(e.C||0).toFixed(1);

      const tdX = document.createElement("td");
      const x = document.createElement("button");
      x.className = "xbtn";
      x.textContent = "–£–¥–∞–ª–∏—Ç—å";
      x.onclick = () => {
        const d = ensureDay(viewDay);
        d.entries = d.entries.filter(z => z.id !== e.id);
        saveAll();
        renderAll();
      };
      tdX.appendChild(x);

      tr.appendChild(tdT);
      tr.appendChild(tdN);
      tr.appendChild(tdPor);
      tr.appendChild(tdK);
      tr.appendChild(tdP);
      tr.appendChild(tdF);
      tr.appendChild(tdC);
      tr.appendChild(tdX);

      entriesTbody.appendChild(tr);
    }
  }

  function renderFoodsTable(){
    foodsTbody.innerHTML = "";
    for (const f of foods){
      const tr = document.createElement("tr");

      const tdN = document.createElement("td");
      tdN.textContent = f.name;

      const tdK = document.createElement("td");
      tdK.textContent = String(Math.round(kcalOf(safeNum(f.P), safeNum(f.F), safeNum(f.C))));

      const tdP = document.createElement("td");
      tdP.textContent = round1(safeNum(f.P)).toFixed(1);

      const tdF = document.createElement("td");
      tdF.textContent = round1(safeNum(f.F)).toFixed(1);

      const tdC = document.createElement("td");
      tdC.textContent = round1(safeNum(f.C)).toFixed(1);

      const tdX = document.createElement("td");
      const del = document.createElement("button");
      del.className = "xbtn";
      del.textContent = "–£–¥–∞–ª–∏—Ç—å";
      del.onclick = () => {
        // —É–¥–∞–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç –∏ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞ –Ω–µ–≥–æ —Å—Å—ã–ª–∞—é—Ç—Å—è
        foods = foods.filter(x => x.id !== f.id);
        for (const k of Object.keys(days)){
          const d = ensureDay(k);
          d.entries = d.entries.filter(e => e.foodId !== f.id);
        }
        saveAll();
        renderAll();
      };
      tdX.appendChild(del);

      tr.appendChild(tdN);
      tr.appendChild(tdK);
      tr.appendChild(tdP);
      tr.appendChild(tdF);
      tr.appendChild(tdC);
      tr.appendChild(tdX);

      foodsTbody.appendChild(tr);
    }
  }

  function renderHistory(){
    const today = new Date();
    const rows = [];
    for (let i=0; i<14; i++){
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = fmtDate(d);
      const day = ensureDay(key);
      const t = computeTotals(day);
      rows.push({
        key,
        kcal: Math.round(t.K),
        protein: round1(t.P).toFixed(1),
        water: Math.round(day.waterMl || 0),
        weight: (day.weightKg == null ? "‚Äî" : Number(day.weightKg).toFixed(1))
      });
    }

    histTbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      const tdD = document.createElement("td");
      tdD.innerHTML = `<div><b>${r.key}</b></div><div class="small">${r.key===viewDay ? "(–æ—Ç–∫—Ä—ã—Ç)" : ""}</div>`;

      const tdK = document.createElement("td"); tdK.textContent = String(r.kcal);
      const tdP = document.createElement("td"); tdP.textContent = String(r.protein);
      const tdW = document.createElement("td"); tdW.textContent = String(r.water);
      const tdWe = document.createElement("td"); tdWe.textContent = String(r.weight);

      tr.appendChild(tdD);
      tr.appendChild(tdK);
      tr.appendChild(tdP);
      tr.appendChild(tdW);
      tr.appendChild(tdWe);

      histTbody.appendChild(tr);
    });
  }

  function renderGoalsUI(){
    goalProteinInp.value = goals.protein ?? "";
    goalWaterInp.value = goals.water ?? "";
  }

  function renderAll(){
    renderDayHeader();
    renderFoodsSelect();
    renderQuickButtons();
    renderEntries();
    renderFoodsTable();
    renderGoalsUI();
    renderTotals();
    renderHistory();
  }

  // ========= Actions =========
  function addEntry(foodId, portions){
    const f = getFoodById(foodId);
    if (!f) return;

    const p = Math.max(0, safeNum(portions, 1));
    if (p <= 0) return;

    const P = safeNum(f.P) * p;
    const F = safeNum(f.F) * p;
    const C = safeNum(f.C) * p;
    const K = kcalOf(P, F, C);

    const day = ensureDay(viewDay);
    day.entries.push({
      id: crypto.randomUUID(),
      time: nowTime(),
      foodId: f.id,
      name: f.name,
      portions: round1(p),
      P, F, C,
      kcal: K
    });

    saveAll();
    renderAll();
  }

  // Day navigation
  dayPrev.onclick = () => {
    const d = new Date(viewDay + "T00:00:00");
    d.setDate(d.getDate() - 1);
    viewDay = fmtDate(d);
    saveAll();
    renderAll();
  };
  dayNext.onclick = () => {
    const d = new Date(viewDay + "T00:00:00");
    d.setDate(d.getDate() + 1);
    viewDay = fmtDate(d);
    saveAll();
    renderAll();
  };
  dayToday.onclick = () => {
    viewDay = fmtDate(new Date());
    saveAll();
    renderAll();
  };

  copyYesterday.onclick = () => {
    const d = new Date(viewDay + "T00:00:00");
    const y = new Date(d);
    y.setDate(y.getDate() - 1);
    const yKey = fmtDate(y);

    const src = ensureDay(yKey);
    const dst = ensureDay(viewDay);

    dst.entries = (src.entries || []).map(e => ({...e, id: crypto.randomUUID(), time: e.time || nowTime()}));
    dst.waterMl = src.waterMl || 0;
    dst.burnedKcal = src.burnedKcal || 0;
    dst.weightKg = src.weightKg ?? null;

    saveAll();
    renderAll();
  };

  resetDay.onclick = () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–Ω—å? –ï–¥–∞, –≤–æ–¥–∞, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –≤–µ—Å ‚Äî –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è.");
    if (!ok) return;
    days[viewDay] = { entries: [], waterMl: 0, burnedKcal: 0, weightKg: null };
    saveAll();
    renderAll();
  };

  // Eat add
  eatAdd.onclick = () => {
    const id = eatFood.value;
    const p = safeNum(eatPortions.value, 1);
    addEntry(id, p);
    eatPortions.value = "";
  };

  // Water buttons
  document.querySelectorAll("[data-water]").forEach(btn => {
    btn.addEventListener("click", () => {
      const delta = safeNum(btn.getAttribute("data-water"), 0);
      const day = ensureDay(viewDay);
      day.waterMl = Math.max(0, safeNum(day.waterMl, 0) + delta);
      saveAll();
      renderAll();
    });
  });
  waterReset.onclick = () => {
    const day = ensureDay(viewDay);
    day.waterMl = 0;
    saveAll();
    renderAll();
  };

  // Burn
  burnAdd.onclick = () => {
    const v = Math.max(0, safeNum(burnInp.value, 0));
    const day = ensureDay(viewDay);
    day.burnedKcal = Math.max(0, safeNum(day.burnedKcal, 0) + v);
    burnInp.value = "";
    saveAll();
    renderAll();
  };
  burnReset.onclick = () => {
    const day = ensureDay(viewDay);
    day.burnedKcal = 0;
    saveAll();
    renderAll();
  };

  // Weight
  weightSave.onclick = () => {
    const v = safeNum(weightInp.value, NaN);
    const day = ensureDay(viewDay);
    if (!Number.isFinite(v) || v <= 0) return;
    day.weightKg = v;
    weightInp.value = "";
    saveAll();
    renderAll();
  };
  weightClear.onclick = () => {
    const day = ensureDay(viewDay);
    day.weightKg = null;
    saveAll();
    renderAll();
  };

  // Foods add
  foodAdd.onclick = () => {
    const name = (foodName.value || "").trim();
    if (!name) return;
    const P = Math.max(0, safeNum(foodP.value, 0));
    const F = Math.max(0, safeNum(foodF.value, 0));
    const C = Math.max(0, safeNum(foodC.value, 0));

    foods.unshift({ id: crypto.randomUUID(), name, P, F, C });

    foodName.value = "";
    foodP.value = "";
    foodF.value = "";
    foodC.value = "";

    saveAll();
    renderAll();
  };

  // Goals
  saveGoalsBtn.onclick = () => {
    const p = Math.max(0, safeNum(goalProteinInp.value, goals.protein || 0));
    const w = Math.max(0, safeNum(goalWaterInp.value, goals.water || 0));
    goals.protein = Math.round(p);
    goals.water = Math.round(w);
    saveAll();
    renderAll();
  };

  // Backup export/import
  exportBtn.onclick = async () => {
    const payload = {
      v: 5,
      foods,
      days,
      viewDay,
      goals
    };
    const txt = JSON.stringify(payload);
    backupArea.value = txt;

    try{
      await navigator.clipboard.writeText(txt);
      alert("–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤. –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚úÖ");
    }catch{
      alert("–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤. –°–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é ‚úÖ");
    }
  };

  importBtn.onclick = () => {
    const txt = (backupArea.value || "").trim();
    if (!txt) return alert("–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –ø–æ–ª–µ.");
    let obj;
    try{ obj = JSON.parse(txt); }catch{ return alert("–ù–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JSON. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å—Ç–∞–≤–∏–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é."); }

    if (!obj || typeof obj !== "object") return alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
    if (!Array.isArray(obj.foods) || !obj.days) return alert("–í —ç–∫—Å–ø–æ—Ä—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç foods/days.");

    const ok = confirm("–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?");
    if (!ok) return;

    foods = obj.foods;
    days = obj.days;
    viewDay = obj.viewDay || fmtDate(new Date());
    goals = obj.goals || { protein: 140, water: 2500 };

    saveAll();
    renderAll();
    alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ");
  };

  // init
  ensureDay(viewDay);
  saveAll();
  renderAll();

})();
</script>
</body>
</html>
