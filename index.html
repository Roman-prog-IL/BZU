<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–ñ–£ + –í–æ–¥–∞ + –ò—Å—Ç–æ—Ä–∏—è</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#e9eef7;
      --muted:#a7b0c2;
      --line:#243044;
      --blue:#2a6cf6;
      --red:#c63a3a;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky;top:0;z-index:5;
      background:linear-gradient(180deg, rgba(11,12,16,.98), rgba(11,12,16,.92));
      border-bottom:1px solid rgba(255,255,255,.05);
      padding:12px 14px;
      backdrop-filter: blur(10px);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{font-weight:800;font-size:16px}
    .container{max-width:980px;margin:0 auto;padding:12px}
    .grid{display:grid;gap:12px;grid-template-columns: 1.25fr .75fr;align-items:start}
    .card{
      background: radial-gradient(1100px 360px at 20% -10%, rgba(42,108,246,.14), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    h2{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.nowrap{flex-wrap:nowrap}
    .pill{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      display:flex;gap:8px;align-items:center;
      min-height:38px;
    }
    .pill b{font-weight:900}
    .sep{height:1px;background:rgba(255,255,255,.07);margin:10px 0}
    button{
      border:0;border-radius:12px;
      padding:11px 12px;font-weight:800;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    button.primary{background:linear-gradient(180deg, rgba(42,108,246,1), rgba(42,108,246,.82))}
    button.danger{background:linear-gradient(180deg, rgba(198,58,58,1), rgba(198,58,58,.82))}
    button:active{transform:translateY(1px)}
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:11px 12px;
      outline:none;
      font-size:15px;
    }
    input::placeholder, textarea::placeholder{color:rgba(233,238,247,.35)}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    th,td{padding:10px 10px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{color:var(--muted);font-weight:800;background:rgba(255,255,255,.03);text-align:left}
    tr:last-child td{border-bottom:0}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .kpi2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .kpi3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    .kpi4{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .right{display:flex;flex-direction:column;gap:12px}
    .w160{width:160px}
    .mini{width:120px}
    .topBtns{display:flex;gap:10px;align-items:center}

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å */
    @media (max-width: 820px){
      .container{padding:10px}
      .grid{grid-template-columns:1fr}
      .row.nowrap{flex-wrap:wrap}
      .w160,.mini{width:100%}
      th:nth-child(3), td:nth-child(3) {display:none;} /* –ø–æ—Ä—Ü–∏–∏ */
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .modalWrap{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;z-index:50;background:rgba(0,0,0,.55)}
    .modal{
      width:100%;
      max-width:980px;
      background:linear-gradient(180deg, rgba(17,19,26,.98), rgba(17,19,26,.96));
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px 20px 0 0;
      box-shadow: 0 -20px 60px rgba(0,0,0,.55);
      padding:14px;
      max-height:86vh;
      overflow:auto;
    }
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .modalHeader b{font-size:16px}
  </style>
</head>

<body>
<header>
  <div class="title">–ë–ñ–£ / –í–æ–¥–∞ / –ò—Å—Ç–æ—Ä–∏—è (v6)</div>
  <div class="topBtns">
    <button id="openSettings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT -->
    <div>
      <!-- –î–µ–Ω—å -->
      <div class="card">
        <h2>–î–µ–Ω—å</h2>
        <div class="row nowrap">
          <button id="prevDayBtn">‚óÄ</button>
          <div class="pill" style="flex:1 1 auto;justify-content:center"><b id="dayLabel">‚Äî</b></div>
          <button id="nextDayBtn">‚ñ∂</button>
          <button class="primary" id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="copyYesterdayBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞</button>
          <button class="danger" id="resetDayBtn">–°–±—Ä–æ—Å –¥–Ω—è</button>
        </div>
        <div class="small" style="margin-top:8px">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.</div>
      </div>

      <!-- –ò—Ç–æ–≥–∏ (—à–∏—Ä–æ–∫–æ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ) -->
      <div class="card">
        <h2>–ò—Ç–æ–≥–∏</h2>

        <div class="kpi2">
          <div class="pill">üçΩÔ∏è –°—ä–µ–ª: <b id="uiEaten">0</b> –∫–∫–∞–ª</div>
          <div class="pill">üî• –°–æ–∂–∂–µ–Ω–æ: <b id="uiBurned">0</b> –∫–∫–∞–ª</div>
          <div class="pill">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: <b id="uiBalance">0</b> –∫–∫–∞–ª</div>
          <div class="pill">üíß –í–æ–¥–∞: <b id="uiWater">0</b> –º–ª</div>
        </div>

        <div class="sep"></div>

        <div class="kpi3">
          <div class="pill">–ë <b id="uiP">0.0</b> –≥</div>
          <div class="pill">–ñ <b id="uiF">0.0</b> –≥</div>
          <div class="pill">–£ <b id="uiC">0.0</b> –≥</div>
        </div>

        <div class="sep"></div>

        <div class="kpi4">
          <div class="pill">üéØ –¶–µ–ª—å –±–µ–ª–∫–∞: <b id="uiProteinGoal">140</b> –≥</div>
          <div class="pill">ü•© –û—Å—Ç–∞–ª–æ—Å—å: <b id="uiProteinLeft">0</b> –≥</div>
          <div class="pill">üíß –¶–µ–ª—å –≤–æ–¥—ã: <b id="uiWaterGoal">2500</b> –º–ª</div>
          <div class="pill">üíß –û—Å—Ç–∞–ª–æ—Å—å: <b id="uiWaterLeft">0</b> –º–ª</div>
        </div>

        <div class="sep"></div>

        <div class="pill">‚öñÔ∏è –í–µ—Å: <b id="uiWeight">‚Äî</b> –∫–≥</div>

        <div class="small" id="uiTip" style="margin-top:10px"></div>
      </div>

      <!-- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫, –∫–∞–∫ —Ç—ã —Ö–æ—Ç–µ–ª) -->
      <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º</h2>
        <div class="row">
          <select id="foodSelect">
            <option value="">–ù–∞–∂–º–∏ –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç‚Ä¶</option>
          </select>
          <input id="portionInp" type="number" step="0.5" min="0" placeholder="–ø–æ—Ä—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)" class="mini" />
          <button class="primary" id="addMealBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="small" style="margin-top:8px">
          –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç ‚Äî –æ–Ω –¥–æ–±–∞–≤–∏—Ç—Å—è —Å—Ä–∞–∑—É (1 –ø–æ—Ä—Ü–∏—è). –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–µ ‚Äî –≤–≤–µ–¥–∏ –ø–æ—Ä—Ü–∏–∏ –∏ –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª.
        </div>

        <div class="sep"></div>

        <table>
          <thead>
            <tr>
              <th>–í—Ä–µ–º—è</th>
              <th>–ü—Ä–æ–¥—É–∫—Ç</th>
              <th>–ü–æ—Ä—Ü.</th>
              <th>–ö–∫–∞–ª</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <div class="card">
        <h2>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)</h2>
        <table>
          <thead>
            <tr><th>–î–∞—Ç–∞</th><th>–ö–∫–∞–ª</th><th>–ë–µ–ª–æ–∫</th><th>–í–æ–¥–∞</th><th>–í–µ—Å</th></tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
        <div class="small" style="margin-top:8px">–ù–∞–∂–º–∏ –¥–∞—Ç—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ—Ç –¥–µ–Ω—å.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="card">
        <h2>–í–æ–¥–∞</h2>
        <div class="row">
          <button id="w200">+200</button>
          <button id="w300">+300</button>
          <button id="w500">+500</button>
          <button id="wMinus200">-200</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="danger" id="wReset">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="card">
        <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–∫–∫–∞–ª)</h2>
        <div class="row">
          <input id="burnInp" type="number" step="1" min="0" placeholder="–∫–∫–∞–ª" class="w160">
          <button class="primary" id="burnAddBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="danger" id="burnResetBtn">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="card">
        <h2>–í–µ—Å (–∫–≥)</h2>
        <div class="row">
          <input id="weightInp" type="number" step="0.1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 73.0" class="w160">
          <button class="primary" id="weightSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="danger" id="weightResetBtn">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="modalHeader">
      <b>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>
      <button id="closeSettings" class="danger">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="card" style="padding:12px">
      <h2>–¶–µ–ª–∏</h2>
      <div class="row">
        <input id="goalProteinInp" type="number" step="1" min="0" placeholder="–ë–µ–ª–æ–∫ (–≥/–¥–µ–Ω—å)" class="w160">
        <input id="goalWaterInp" type="number" step="50" min="0" placeholder="–í–æ–¥–∞ (–º–ª/–¥–µ–Ω—å)" class="w160">
        <button class="primary" id="saveGoalsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div class="small" id="goalsHint" style="margin-top:8px"></div>
    </div>

    <div class="card" style="padding:12px">
      <h2>–ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é)</h2>
      <div class="row">
        <input id="newName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –¢–≤–æ—Ä–æ–≥ 200 –≥)" />
      </div>
      <div class="row" style="margin-top:10px">
        <input id="newK" type="number" step="1" min="0" placeholder="–ö–∫–∞–ª (–º–æ–∂–Ω–æ –ø—É—Å—Ç–æ)" class="mini"/>
        <input id="newP" type="number" step="0.1" min="0" placeholder="–ë" class="mini"/>
        <input id="newF" type="number" step="0.1" min="0" placeholder="–ñ" class="mini"/>
        <input id="newC" type="number" step="0.1" min="0" placeholder="–£" class="mini"/>
        <button class="primary" id="addFoodBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="small" style="margin-top:8px">
        –ï—Å–ª–∏ –ö–∫–∞–ª –ø—É—Å—Ç–æ ‚Äî –ø–æ—Å—á–∏—Ç–∞—é: –ë*4 + –£*4 + –ñ*9
      </div>

      <div class="sep"></div>

      <table>
        <thead>
          <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∫–∞–ª</th><th>–ë</th><th>–ñ</th><th>–£</th><th></th></tr>
        </thead>
        <tbody id="foodsBody"></tbody>
      </table>

      <div class="sep"></div>
      <div class="row">
        <button class="danger" id="resetFoodsBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã v5/v6 (–ø–æ—á–∏–Ω–∏—Ç—å NaN)</button>
      </div>
      <div class="small" style="margin-top:6px">
        –ù–∞–∂–º–∏ –æ–¥–∏–Ω —Ä–∞–∑, –µ—Å–ª–∏ –≤–∏–¥–∏—à—å NaN –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.
      </div>
    </div>

    <div class="card" style="padding:12s12px">
      <h2>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h2>
      <div class="row">
        <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="danger" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
      </div>
      <div class="small" style="margin-top:8px">
        –≠–∫—Å–ø–æ—Ä—Ç ‚Äî —Å–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–º–µ—Ç–∫–∏. –ò–º–ø–æ—Ä—Ç ‚Äî –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ò–º–ø–æ—Ä—Ç¬ª.
      </div>
      <div style="margin-top:10px">
        <textarea id="backupBox" rows="6" placeholder="–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —ç–∫—Å–ø–æ—Ä—Ç –∏–ª–∏ —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å –∏–º–ø–æ—Ä—Ç‚Ä¶"></textarea>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== keys =====
  const KEY_FOODS = "bzu_foods_v6";
  const KEY_DAYS  = "bzu_days_v6";
  const KEY_GOALS = "bzu_goals_v6";
  const KEY_VIEW  = "bzu_viewday_v6";

  // ===== helpers =====
  const pad2 = n => String(n).padStart(2,"0");
  const todayKey = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseNum = (v, def=0) => {
    const x = Number(String(v ?? "").replace(",", "."));
    return Number.isFinite(x) ? x : def;
  };
  const round1 = x => Math.round(x*10)/10;
  const clamp0 = x => Math.max(0, x);

  function fmtDateRU(iso){
    const [y,m,d]=iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("ru-RU", {day:"2-digit", month:"short", year:"numeric"});
  }
  function nowTime(){
    const d=new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function isoToDate(iso){
    const [y,m,d]=iso.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function cryptoId(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // ===== defaults =====
  function defaultFoods(){
    return [
      {id:cryptoId(), name:"–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)", k:71, p:6.0, f:5.0, c:0.6},
      {id:cryptoId(), name:"–Ø–±–ª–æ–∫–æ (1 —à—Ç)", k:103, p:0.3, f:0.2, c:27.0},
      {id:cryptoId(), name:"–ë–∞–Ω–∞–Ω (1 —à—Ç)", k:117, p:1.3, f:0.4, c:30.0},
      {id:cryptoId(), name:"–û—Ä–µ—Ö–∏ (30 –≥)", k:206, p:5.0, f:18.0, c:6.0},
      {id:cryptoId(), name:"–¢–≤–æ—Ä–æ–≥ (200 –≥)", k:226, p:28.0, f:10.0, c:8.0},
      {id:cryptoId(), name:"–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (150 –≥)", k:220, p:46.0, f:4.0, c:0.0},
      {id:cryptoId(), name:"–¢—É–Ω–µ—Ü (–±–∞–Ω–∫–∞ 120 –≥)", k:121, p:28.0, f:1.0, c:0.0},
      {id:cryptoId(), name:"–ô–æ–≥—É—Ä—Ç –≥—Ä–µ—á–µ—Å–∫–∏–π (200 –≥)", k:157, p:20.0, f:5.0, c:8.0},
    ];
  }

  // ===== load =====
  let foods = JSON.parse(localStorage.getItem(KEY_FOODS) || "null");
  let days  = JSON.parse(localStorage.getItem(KEY_DAYS)  || "null");
  let goals = JSON.parse(localStorage.getItem(KEY_GOALS) || "null");
  let viewDay = localStorage.getItem(KEY_VIEW) || todayKey();

  if(!Array.isArray(foods) || foods.length===0) foods = defaultFoods();
  if(!days || typeof days!=="object") days = {};
  if(!goals || typeof goals!=="object") goals = {protein:140, water:2500};

  // ===== IMPORTANT: auto-fix NaN / bad data =====
  function normalizeFood(f){
    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—ã–ª–∏)
    const name = String(f.name ?? f.title ?? "").trim();
    const p = parseNum(f.p ?? f.protein, 0);
    const fat = parseNum(f.f ?? f.fat, 0);
    const c = parseNum(f.c ?? f.carbs, 0);
    let k = parseNum(f.k ?? f.kcal ?? f.calories, NaN);
    if(!Number.isFinite(k) || k <= 0){
      k = Math.round(p*4 + c*4 + fat*9);
    }
    return {
      id: String(f.id ?? cryptoId()),
      name: name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
      k: Math.max(0, k),
      p: Math.max(0, p),
      f: Math.max(0, fat),
      c: Math.max(0, c),
    };
  }
  foods = foods.map(normalizeFood);

  function ensureDay(k){
    if(!days[k]) days[k] = { items:[], water:0, burned:0, weight:null };
    const d = days[k];
    if(!Array.isArray(d.items)) d.items = [];
    d.water = clamp0(parseNum(d.water, 0));
    d.burned = clamp0(parseNum(d.burned, 0));
    d.weight = (d.weight==null ? null : parseNum(d.weight, null));
    // normalize items
    d.items = d.items.map(it=>{
      const portions = Math.max(0.1, parseNum(it.portions ?? it.qty ?? 1, 1));
      const p = parseNum(it.p, 0);
      const fat = parseNum(it.f, 0);
      const c = parseNum(it.c, 0);
      let k = parseNum(it.k, NaN);
      if(!Number.isFinite(k)){
        k = Math.round(p*4 + c*4 + fat*9);
      }
      return {
        t: String(it.t ?? it.time ?? "‚Äî"),
        foodId: String(it.foodId ?? it.id ?? ""),
        name: String(it.name ?? it.title ?? "‚Äî"),
        portions,
        k: clamp0(k),
        p: clamp0(p),
        f: clamp0(fat),
        c: clamp0(c),
      };
    });
    return d;
  }

  function saveAll(){
    localStorage.setItem(KEY_FOODS, JSON.stringify(foods));
    localStorage.setItem(KEY_DAYS, JSON.stringify(days));
    localStorage.setItem(KEY_GOALS, JSON.stringify(goals));
    localStorage.setItem(KEY_VIEW, viewDay);
  }

  // ===== UI refs =====
  const dayLabel = document.getElementById("dayLabel");
  const uiEaten = document.getElementById("uiEaten");
  const uiBurned = document.getElementById("uiBurned");
  const uiBalance = document.getElementById("uiBalance");
  const uiWater = document.getElementById("uiWater");
  const uiWeight = document.getElementById("uiWeight");
  const uiP = document.getElementById("uiP");
  const uiF = document.getElementById("uiF");
  const uiC = document.getElementById("uiC");
  const uiProteinGoal = document.getElementById("uiProteinGoal");
  const uiProteinLeft = document.getElementById("uiProteinLeft");
  const uiWaterGoal = document.getElementById("uiWaterGoal");
  const uiWaterLeft = document.getElementById("uiWaterLeft");
  const uiTip = document.getElementById("uiTip");

  const prevDayBtn = document.getElementById("prevDayBtn");
  const nextDayBtn = document.getElementById("nextDayBtn");
  const todayBtn = document.getElementById("todayBtn");
  const copyYesterdayBtn = document.getElementById("copyYesterdayBtn");
  const resetDayBtn = document.getElementById("resetDayBtn");

  const foodSelect = document.getElementById("foodSelect");
  const portionInp = document.getElementById("portionInp");
  const addMealBtn = document.getElementById("addMealBtn");
  const logBody = document.getElementById("logBody");
  const histBody = document.getElementById("histBody");

  const w200 = document.getElementById("w200");
  const w300 = document.getElementById("w300");
  const w500 = document.getElementById("w500");
  const wMinus200 = document.getElementById("wMinus200");
  const wReset = document.getElementById("wReset");

  const burnInp = document.getElementById("burnInp");
  const burnAddBtn = document.getElementById("burnAddBtn");
  const burnResetBtn = document.getElementById("burnResetBtn");

  const weightInp = document.getElementById("weightInp");
  const weightSaveBtn = document.getElementById("weightSaveBtn");
  const weightResetBtn = document.getElementById("weightResetBtn");

  // settings
  const modalWrap = document.getElementById("modalWrap");
  const openSettings = document.getElementById("openSettings");
  const closeSettings = document.getElementById("closeSettings");

  const goalProteinInp = document.getElementById("goalProteinInp");
  const goalWaterInp = document.getElementById("goalWaterInp");
  const saveGoalsBtn = document.getElementById("saveGoalsBtn");
  const goalsHint = document.getElementById("goalsHint");

  const newName = document.getElementById("newName");
  const newK = document.getElementById("newK");
  const newP = document.getElementById("newP");
  const newF = document.getElementById("newF");
  const newC = document.getElementById("newC");
  const addFoodBtn = document.getElementById("addFoodBtn");
  const foodsBody = document.getElementById("foodsBody");
  const resetFoodsBtn = document.getElementById("resetFoodsBtn");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const backupBox = document.getElementById("backupBox");

  // ===== computations =====
  function totalsForDay(k){
    const d = ensureDay(k);
    let eatenK=0, P=0, F=0, C=0;
    for(const it of d.items){
      eatenK += parseNum(it.k, 0);
      P += parseNum(it.p, 0);
      F += parseNum(it.f, 0);
      C += parseNum(it.c, 0);
    }
    return {
      eatenK: Math.round(eatenK),
      burnedK: Math.round(d.burned || 0),
      balanceK: Math.round(eatenK - (d.burned||0)),
      water: Math.round(d.water || 0),
      weight: (d.weight==null ? null : d.weight),
      P: round1(P),
      F: round1(F),
      C: round1(C),
    };
  }

  function proteinTip(leftP){
    if(leftP <= 0) return "‚úÖ –ë–µ–ª–æ–∫ –∑–∞–∫—Ä—ã—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.";
    const best = foods
      .slice()
      .sort((a,b)=> (parseNum(b.p,0)/(parseNum(b.k,1))) - (parseNum(a.p,0)/(parseNum(a.k,1))) )[0] || foods[0];
    const portions = Math.max(1, Math.round(leftP / Math.max(1, parseNum(best.p,1))));
    return `üí° –û—Å—Ç–∞–ª–æ—Å—å –¥–æ–±—Ä–∞—Ç—å <b>${Math.ceil(leftP)}</b> –≥ –±–µ–ª–∫–∞. –ü—Ä–∏–º–µ—Ä: <b>${portions}</b> –ø–æ—Ä—Ü. ¬´${escapeHtml(best.name)}¬ª.`;
  }

  // ===== render =====
  function renderDayHeader(){
    dayLabel.textContent = fmtDateRU(viewDay);
  }

  function renderFoodSelect(){
    const cur = foodSelect.value;
    foodSelect.innerHTML =
      `<option value="">–ù–∞–∂–º–∏ –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç‚Ä¶</option>` +
      foods.map(f=>`<option value="${f.id}">${escapeHtml(f.name)}</option>`).join("");
    if(cur) foodSelect.value = cur;
  }

  function renderLog(){
    const d = ensureDay(viewDay);
    logBody.innerHTML = d.items.map((it, idx)=>{
      return `
        <tr>
          <td>${escapeHtml(it.t)}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${round1(it.portions).toFixed(1)}</td>
          <td>${Math.round(parseNum(it.k,0))}</td>
          <td><button class="danger" data-del="${idx}">–£–¥–∞–ª–∏—Ç—å</button></td>
        </tr>
      `;
    }).join("");

    logBody.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const d = ensureDay(viewDay);
        const i = Number(btn.getAttribute("data-del"));
        d.items.splice(i,1);
        saveAll(); renderAll();
      };
    });
  }

  function renderHistory(){
    const keys = [];
    const base = isoToDate(viewDay);
    for(let i=0;i<14;i++){
      const dt = new Date(base);
      dt.setDate(dt.getDate()-i);
      keys.push(todayKey(dt));
    }

    histBody.innerHTML = keys.map(k=>{
      const t = totalsForDay(k);
      return `
        <tr>
          <td>
            <button style="padding:8px 10px;border-radius:10px"
              data-open="${k}">${k}${k===viewDay?` <span style="opacity:.6">(–æ—Ç–∫—Ä—ã—Ç)</span>`:""}</button>
          </td>
          <td>${t.eatenK}</td>
          <td>${t.P.toFixed(1)}</td>
          <td>${t.water}</td>
          <td>${t.weight==null ? "‚Äî" : round1(t.weight).toFixed(1)}</td>
        </tr>
      `;
    }).join("");

    histBody.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = ()=>{
        viewDay = b.getAttribute("data-open");
        saveAll(); renderAll();
        window.scrollTo({top:0, behavior:"smooth"});
      };
    });
  }

  function renderTotals(){
    const t = totalsForDay(viewDay);

    uiEaten.textContent = String(t.eatenK);
    uiBurned.textContent = String(t.burnedK);
    uiBalance.textContent = String(t.balanceK);
    uiWater.textContent = String(t.water);
    uiWeight.textContent = (t.weight==null ? "‚Äî" : round1(t.weight).toFixed(1));

    uiP.textContent = t.P.toFixed(1);
    uiF.textContent = t.F.toFixed(1);
    uiC.textContent = t.C.toFixed(1);

    const gp = Math.max(0, Math.round(parseNum(goals.protein, 0)));
    const gw = Math.max(0, Math.round(parseNum(goals.water, 0)));

    uiProteinGoal.textContent = String(gp);
    uiWaterGoal.textContent = String(gw);

    const leftP = gp>0 ? (gp - t.P) : 0;
    uiProteinLeft.textContent = gp>0
      ? (leftP>=0 ? String(Math.ceil(leftP)) :
