<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ë–ñ–£ ‚Äî –ü–æ—Ä—Ü–∏–∏ v4</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e6edf3}
  .wrap{max-width:900px;margin:auto;padding:16px}
  .card{background:#111826;border:1px solid #223044;border-radius:16px;padding:14px;margin-bottom:12px}
  h1{margin:0 0 10px;font-size:22px}
  h2{margin:0 0 10px;font-size:16px;opacity:.95}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{
    background:#0b1220;color:#e6edf3;border:1px solid #223044;border-radius:12px;
    padding:10px 12px;font-size:16px
  }
  select{min-width:260px}
  input[type="number"]{width:140px}
  button{cursor:pointer}
  .primary{background:#1f6feb;border-color:#1f6feb}
  .danger{background:#b42318;border-color:#b42318}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid #223044;border-radius:999px;background:#0b1220}
  .sep{height:1px;background:#223044;margin:10px 0}
  .small{font-size:13px;opacity:.82}
  .muted{opacity:.8}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .list{list-style:none;padding:0;margin:10px 0 0}
  .item{background:#0b1220;border:1px solid #223044;border-radius:14px;padding:10px;margin-bottom:8px}
  .itemTop{display:flex;justify-content:space-between;gap:10px}
  .itemName{font-weight:700}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid #223044;font-size:14px}
  th{opacity:.8;text-align:left}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>–ë–ñ–£ / –ü–æ—Ä—Ü–∏–∏ / –ò—Å—Ç–æ—Ä–∏—è (v4)</h1>

  <div class="card">
    <h2>–î–µ–Ω—å</h2>
    <div class="row">
      <button id="prevDay">‚óÄÔ∏é</button>
      <input id="dayInput" type="date">
      <button id="nextDay">‚ñ∂Ô∏é</button>
      <button id="todayBtn" class="primary">–°–µ–≥–æ–¥–Ω—è</button>
      <button id="copyYesterday">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞</button>
      <button id="resetDay" class="danger">–°–±—Ä–æ—Å –¥–Ω—è</button>
    </div>
    <div class="small" style="margin-top:6px">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.</div>
  </div>

  <div class="card">
    <h2>–ò—Ç–æ–≥–∏</h2>
    <div class="row">
      <span class="pill">üçΩÔ∏è –°—ä–µ–ª: <b id="kcalIn">0</b> –∫–∫–∞–ª</span>
      <span class="pill">üî• –°–æ–∂–∂–µ–Ω–æ: <b id="kcalBurn">0</b> –∫–∫–∞–ª</span>
      <span class="pill">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å: <b id="kcalNet">0</b> –∫–∫–∞–ª</span>
      <span class="pill">üíß –í–æ–¥–∞: <b id="waterMl">0</b> –º–ª</span>
      <span class="pill">‚öñÔ∏è –í–µ—Å: <b id="weightShow">‚Äî</b> –∫–≥</span>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span class="pill">–ë <b id="pTot">0.0</b> –≥</span>
      <span class="pill">–ñ <b id="fTot">0.0</b> –≥</span>
      <span class="pill">–£ <b id="cTot">0.0</b> –≥</span>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span class="pill">üéØ –¶–µ–ª—å –±–µ–ª–∫–∞: <b id="pGoal">130</b> –≥</span>
      <span class="pill">üìå –û—Å—Ç–∞–ª–æ—Å—å –±–µ–ª–∫–∞: <b id="pLeft">‚Äî</b></span>
      <span class="pill">üíß –¶–µ–ª—å –≤–æ–¥—ã: <b id="wGoal">2500</b> –º–ª</span>
    </div>

    <div class="small" style="margin-top:8px" id="proteinTip"></div>
  </div>

  <div class="grid2">
    <div class="card">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º</h2>
      <div class="row">
        <select id="foodSelect"></select>
        <input id="portionsInput" type="number" step="0.5" min="0.5" placeholder="–ø–æ—Ä—Ü–∏–∏">
        <button id="addMeal" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div class="sep"></div>

      <h2>–ë—ã—Å—Ç—Ä–æ (1 —Ç–∞–ø)</h2>
      <div class="row" id="quickFoodRow"></div>

      <ul class="list" id="logWrap"></ul>
    </div>

    <div class="card">
      <h2>–í–æ–¥–∞</h2>
      <div class="row">
        <button data-water="200">+200</button>
        <button data-water="300">+300</button>
        <button data-water="500">+500</button>
        <button id="waterMinus200">-200</button>
        <button id="waterReset" class="danger">–°–±—Ä–æ—Å</button>
      </div>

      <div class="sep"></div>

      <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–∫–∫–∞–ª)</h2>
      <div class="row">
        <input id="burnInput" type="number" min="1" placeholder="–∫–∫–∞–ª">
        <button id="addBurn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="burnReset" class="danger">–°–±—Ä–æ—Å</button>
      </div>

      <div class="sep"></div>

      <h2>–í–µ—Å (–∫–≥)</h2>
      <div class="row">
        <input id="weightInput" type="number" step="0.1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 73.0">
        <button id="saveWeight" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
        <button id="clearWeight" class="danger">–°–±—Ä–æ—Å</button>
      </div>
      <div class="small" style="margin-top:8px">–õ—É—á—à–µ –≤–∑–≤–µ—à–∏–≤–∞—Ç—å—Å—è —É—Ç—Ä–æ–º –ø–æ—Å–ª–µ —Ç—É–∞–ª–µ—Ç–∞, –¥–æ –µ–¥—ã.</div>
    </div>
  </div>

  <div class="card">
    <h2>–ü—Ä–æ–¥—É–∫—Ç—ã (–∑–∞ 1 –ø–æ—Ä—Ü–∏—é)</h2>
    <div class="row">
      <input id="newName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      <input id="newP" type="number" step="0.1" placeholder="–ë">
      <input id="newF" type="number" step="0.1" placeholder="–ñ">
      <input id="newC" type="number" step="0.1" placeholder="–£">
      <button id="addFood" class="primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
    </div>
    <div class="small" style="margin-top:8px">
      –ü—Ä–∏–º–µ—Ä: <span class="mono">–û—Ä–µ—Ö–∏ (30 –≥)</span> –ë=5 –ñ=18 –£=6 ‚Äî —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞ 1 –ø–æ—Ä—Ü–∏—é.
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h2>–¶–µ–ª–∏</h2>
      <div class="row">
        <input id="goalProteinInp" type="number" min="0" placeholder="–¶–µ–ª—å –±–µ–ª–∫–∞ (–≥)">
        <input id="goalWaterInp" type="number" min="0" placeholder="–¶–µ–ª—å –≤–æ–¥—ã (–º–ª)">
        <button id="saveGoals" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div class="small" style="margin-top:8px">
        –Ø –ø–æ—Å—Ç–∞–≤–∏–ª —Å—Ç–∞—Ä—Ç–æ–º: –±–µ–ª–æ–∫ <b>130 –≥</b>, –≤–æ–¥–∞ <b>2500 –º–ª</b>. –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.
      </div>
    </div>

    <div class="card">
      <h2>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)</h2>
      <div id="histWrap" class="small muted">‚Äî</div>
    </div>
  </div>

  <div class="card">
    <h2>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h2>
    <div class="row">
      <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="danger">–ò–º–ø–æ—Ä—Ç</button>
    </div>
    <div class="small" style="margin-top:8px">
      –≠–∫—Å–ø–æ—Ä—Ç –¥–∞—ë—Ç —Ç–µ–∫—Å—Ç. –°–∫–æ–ø–∏—Ä—É–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –≤ –∑–∞–º–µ—Ç–∫–∏. –ò–º–ø–æ—Ä—Ç ‚Äî –≤—Å—Ç–∞–≤—å –æ–±—Ä–∞—Ç–Ω–æ.
    </div>
    <textarea id="backupArea" rows="5" style="width:100%;margin-top:10px" placeholder="–¢—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —ç–∫—Å–ø–æ—Ä—Ç –∏–ª–∏ —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å –∏–º–ø–æ—Ä—Ç‚Ä¶"></textarea>
  </div>

</div>

<script>
(() => {
  // ====== utils ======
  const LS_KEY = "bzu_state_v4";
  const todayISO = () => {
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tz).toISOString().slice(0,10);
  };
  const addDays = (iso, delta) => {
    const [y,m,dd] = iso.split("-").map(Number);
    const d = new Date(y, m-1, dd);
    d.setDate(d.getDate()+delta);
    const tz = d.getTimezoneOffset()*60000;
    return new Date(d.getTime()-tz).toISOString().slice(0,10);
  };
  const kcal = (p,f,c) => p*4 + f*9 + c*4;
  const round1 = (x) => Math.round(x*10)/10;

  const uid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2));

  // ====== defaults ======
  const defaultFoods = () => ([
    { id: uid(), name: "–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ (1 —à—Ç)", p: 6.0, f: 5.0, c: 0.6, quick: true },
    { id: uid(), name: "–Ø–±–ª–æ–∫–æ (1 —à—Ç)",       p: 0.5, f: 0.3, c: 25.0, quick: true },
    { id: uid(), name: "–ë–∞–Ω–∞–Ω (1 —à—Ç)",        p: 1.3, f: 0.4, c: 27.0, quick: true },
    { id: uid(), name: "–û—Ä–µ—Ö–∏ (30 –≥)",        p: 5.0, f: 18.0, c: 6.0,  quick: true }
  ]);

  const load = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  };

  let state = load() || {
    foods: defaultFoods(),
    days: {},
    selectedDate: todayISO(),
    goals: { protein: 130, water: 2500 }
  };

  const ensureDay = (iso) => {
    if (!state.days[iso]) state.days[iso] = { log: [], waterMl: 0, burnedKcal: 0, weightKg: null };
    return state.days[iso];
  };

  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state));

  // ====== elements ======
  const dayInput = document.getElementById("dayInput");
  const prevDay = document.getElementById("prevDay");
  const nextDay = document.getElementById("nextDay");
  const todayBtn = document.getElementById("todayBtn");
  const copyYesterday = document.getElementById("copyYesterday");
  const resetDay = document.getElementById("resetDay");

  const kcalInEl = document.getElementById("kcalIn");
  const kcalBurnEl = document.getElementById("kcalBurn");
  const kcalNetEl = document.getElementById("kcalNet");
  const waterMlEl = document.getElementById("waterMl");
  const pTotEl = document.getElementById("pTot");
  const fTotEl = document.getElementById("fTot");
  const cTotEl = document.getElementById("cTot");
  const weightShow = document.getElementById("weightShow");

  const pGoalEl = document.getElementById("pGoal");
  const pLeftEl = document.getElementById("pLeft");
  const wGoalEl = document.getElementById("wGoal");
  const proteinTip = document.getElementById("proteinTip");

  const foodSelect = document.getElementById("foodSelect");
  const portionsInput = document.getElementById("portionsInput");
  const addMeal = document.getElementById("addMeal");
  const logWrap = document.getElementById("logWrap");
  const quickFoodRow = document.getElementById("quickFoodRow");

  const burnInput = document.getElementById("burnInput");
  const addBurn = document.getElementById("addBurn");
  const burnReset = document.getElementById("burnReset");

  const weightInput = document.getElementById("weightInput");
  const saveWeight = document.getElementById("saveWeight");
  const clearWeight = document.getElementById("clearWeight");

  const addFoodBtn = document.getElementById("addFood");
  const newName = document.getElementById("newName");
  const newP = document.getElementById("newP");
  const newF = document.getElementById("newF");
  const newC = document.getElementById("newC");

  const goalProteinInp = document.getElementById("goalProteinInp");
  const goalWaterInp = document.getElementById("goalWaterInp");
  const saveGoals = document.getElementById("saveGoals");

  const histWrap = document.getElementById("histWrap");

  const backupArea = document.getElementById("backupArea");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");

  // ====== rendering ======
  const currentDay = () => ensureDay(state.selectedDate);

  const renderFoods = () => {
    foodSelect.innerHTML = "";
    state.foods.forEach(f => {
      const o = document.createElement("option");
      o.value = f.id;
      o.textContent = f.name;
      foodSelect.appendChild(o);
    });

    // quick buttons
    quickFoodRow.innerHTML = "";
    state.foods.filter(x => x.quick).slice(0,8).forEach(f => {
      const b = document.createElement("button");
      b.textContent = `+1 ${f.name.replace(/\s*$begin:math:text$\.\+$end:math:text$$/, "")}`;
      b.onclick = () => addFoodToLog(f.id, 1);
      quickFoodRow.appendChild(b);
    });
  };

  const addFoodToLog = (foodId, qty) => {
    const d = currentDay();
    const f = state.foods.find(x => x.id === foodId);
    if (!f) return;

    const p = (Number(f.p)||0) * qty;
    const fat = (Number(f.f)||0) * qty;
    const c = (Number(f.c)||0) * qty;
    const k = kcal(p,fat,c);

    const now = new Date();
    const t = now.toLocaleTimeString("ru-RU", { hour:"2-digit", minute:"2-digit" });

    d.log.unshift({ t, foodId, name: f.name, qty: qty.toString(), p, f: fat, c, k });
    save(); render();
  };

  const renderTotals = () => {
    const d = currentDay();
    let P=0,F=0,C=0,K=0;
    d.log.forEach(e => { P+=e.p; F+=e.f; C+=e.c; K+=e.k; });

    pTotEl.textContent = P.toFixed(1);
    fTotEl.textContent = F.toFixed(1);
    cTotEl.textContent = C.toFixed(1);

    kcalInEl.textContent = Math.round(K);
    kcalBurnEl.textContent = Math.round(d.burnedKcal || 0);
    kcalNetEl.textContent = Math.round(K - (d.burnedKcal || 0));
    waterMlEl.textContent = Math.max(0, d.waterMl || 0);

    weightShow.textContent = (d.weightKg == null) ? "‚Äî" : Number(d.weightKg).toFixed(1);

    // goals & remaining protein
    const goalP = Math.max(0, Number(state.goals?.protein || 0));
    const goalW = Math.max(0, Number(state.goals?.water || 0));
    pGoalEl.textContent = String(goalP || 0);
    wGoalEl.textContent = String(goalW || 0);

    if (goalP <= 0) {
      pLeftEl.textContent = "‚Äî";
      proteinTip.textContent = "";
    } else {
      const left = goalP - P;
      if (left >= 0) {
        pLeftEl.textContent = `${Math.ceil(left)} –≥`;
      } else {
        pLeftEl.textContent = `–ø–µ—Ä–µ–±–æ—Ä +${Math.ceil(Math.abs(left))} –≥`;
      }

      // simple tip using existing foods
      if (left > 0) {
        // choose 3 protein-ish foods by p per portion
        const candidates = state.foods
          .map(x => ({ name: x.name, p: Number(x.p)||0 }))
          .filter(x => x.p > 0)
          .sort((a,b)=>b.p-a.p)
          .slice(0,6);

        if (candidates.length) {
          const best = candidates[0];
          const portions = Math.max(1, Math.round((left / best.p)*2)/2); // step 0.5
          proteinTip.innerHTML =
            `üí° –ß—Ç–æ–±—ã –¥–æ–±—Ä–∞—Ç—å –±–µ–ª–æ–∫: –ø–æ–ø—Ä–æ–±—É–π <b>${portions}</b> –ø–æ—Ä—Ü–∏–∏ <b>${best.name}</b> (–ø—Ä–∏–º–µ—Ä–Ω–æ).`;
        } else {
          proteinTip.textContent = "";
        }
      } else {
        proteinTip.textContent = "";
      }
    }
  };

  const renderLog = () => {
    const d = currentDay();
    logWrap.innerHTML = "";

    if (!d.log.length) {
      logWrap.innerHTML = `<li class="small muted">–ü–æ–∫–∞ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</li>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th><th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th class="right">–ü–æ—Ä—Ü.</th>
            <th class="right">–ö–∫–∞–ª</th>
            <th class="right">–ë</th><th class="right">–ñ</th><th class="right">–£</th>
            <th class="right">‚úï</th>
          </tr>
        </thead><tbody>
    `;
    d.log.forEach((e, idx) => {
      html += `
        <tr>
          <td>${e.t}</td>
          <td>${e.name}</td>
          <td class="right">${e.qty}</td>
          <td class="right">${Math.round(e.k)}</td>
          <td class="right">${e.p.toFixed(1)}</td>
          <td class="right">${e.f.toFixed(1)}</td>
          <td class="right">${e.c.toFixed(1)}</td>
          <td class="right"><button data-del="${idx}" class="danger" style="padding:6px 10px;border-radius:10px;">–£–¥–∞–ª–∏—Ç—å</button></td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    logWrap.innerHTML = html;

    logWrap.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        d.log.splice(i,1);
        save(); render();
      });
    });
  };

  const renderHistory = () => {
    const keys = Object.keys(state.days).sort().reverse().slice(0, 14);
    if (!keys.length) { histWrap.textContent = "–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç."; return; }

    let out = `<table><thead><tr>
      <th>–î–∞—Ç–∞</th><th class="right">–ö–∫–∞–ª</th><th class="right">–ë–µ–ª–æ–∫</th><th class="right">–í–æ–¥–∞</th><th class="right">–í–µ—Å</th>
    </tr></thead><tbody>`;

    keys.forEach(k => {
      const d = state.days[k];
      let P=0,K=0;
      (d.log||[]).forEach(e=>{ P+=e.p; K+=e.k; });
      const water = d.waterMl||0;
      const w = (d.weightKg==null) ? "‚Äî" : Number(d.weightKg).toFixed(1);
      const mark = (k===state.selectedDate) ? " <span class='mono'>(–æ—Ç–∫—Ä—ã—Ç)</span>" : "";
      out += `<tr>
        <td><button data-open="${k}" style="padding:6px 10px;border-radius:10px">${k}</button>${mark}</td>
        <td class="right">${Math.round(K)}</td>
        <td class="right">${P.toFixed(1)}</td>
        <td class="right">${water}</td>
        <td class="right">${w}</td>
      </tr>`;
    });

    out += `</tbody></table>`;
    histWrap.innerHTML = out;

    histWrap.querySelectorAll("button[data-open]").forEach(b=>{
      b.onclick = ()=>{ setDate(b.getAttribute("data-open")); window.scrollTo({top:0,behavior:"smooth"}); };
    });
  };

  const render = () => {
    dayInput.value = state.selectedDate;
    renderFoods();
    renderTotals();
    renderLog();
    renderHistory();
  };

  // ====== date controls ======
  const setDate = (iso) => {
    state.selectedDate = iso;
    ensureDay(iso);
    save();
    render();
  };

  prevDay.onclick = () => setDate(addDays(state.selectedDate, -1));
  nextDay.onclick = () => setDate(addDays(state.selectedDate, +1));
  todayBtn.onclick = () => setDate(todayISO());
  dayInput.onchange = () => setDate(dayInput.value || todayISO());

  resetDay.onclick = () => {
    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ –¥–Ω—è (–µ–¥–∞/–≤–æ–¥–∞/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞/–≤–µ—Å)?")) return;
    state.days[state.selectedDate] = { log: [], waterMl: 0, burnedKcal: 0, weightKg: null };
    save(); render();
  };

  copyYesterday.onclick = () => {
    const y = addDays(state.selectedDate, -1);
    const yd = state.days[y];
    if (!yd || !(yd.log||[]).length) { alert("–í—á–µ—Ä–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π."); return; }
    if (!confirm("–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—á–µ—Ä–∞—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –µ–¥—ã –≤ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å?")) return;
    const d = currentDay();
    // copy only food log
    d.log = yd.log.map(e => ({...e, t: e.t})); // keep same items
    save(); render();
  };

  // ====== add meal ======
  addMeal.onclick = () => {
    const foodId = foodSelect.value;
    const qty = Number(portionsInput.value);
    if (!foodId || !qty || qty <= 0) return;
    addFoodToLog(foodId, qty);
    portionsInput.value = "";
  };

  // ====== water ======
  document.querySelectorAll("button[data-water]").forEach(btn => {
    btn.addEventListener("click", () => {
      const d = currentDay();
      d.waterMl = (d.waterMl || 0) + Number(btn.getAttribute("data-water"));
      save(); renderTotals(); // –±—ã—Å—Ç—Ä–µ–µ
    });
  });

  document.getElementById("waterMinus200").onclick = () => {
    const d = currentDay();
    d.waterMl = Math.max(0, (d.waterMl || 0) - 200);
    save(); renderTotals();
  };

  document.getElementById("waterReset").onclick = () => {
    const d = currentDay();
    d.waterMl = 0;
    save(); renderTotals();
  };

  // ====== burn ======
  addBurn.onclick = () => {
    const d = currentDay();
    const v = Number(burnInput.value);
    if (!v || v <= 0) return;
    d.burnedKcal = (d.burnedKcal || 0) + v;
    burnInput.value = "";
    save(); renderTotals();
  };

  burnReset.onclick = () => {
    const d = currentDay();
    d.burnedKcal = 0;
    save(); renderTotals();
  };

  // ====== weight ======
  saveWeight.onclick = () => {
    const d = currentDay();
    const v = Number(weightInput.value);
    if (!isFinite(v) || v <= 0) return;
    d.weightKg = Math.round(v*10)/10;
    weightInput.value = "";
    save(); renderTotals(); renderHistory();
  };

  clearWeight.onclick = () => {
    const d = currentDay();
    d.weightKg = null;
    save(); renderTotals(); renderHistory();
  };

  // ====== add product ======
  addFoodBtn.onclick = () => {
    const name = (newName.value || "").trim();
    if (!name) return;
    const p = Number(newP.value) || 0;
    const f = Number(newF.value) || 0;
    const c = Number(newC.value) || 0;

    state.foods.push({ id: uid(), name, p, f, c, quick: false });

    newName.value = "";
    newP.value = "";
    newF.value = "";
    newC.value = "";
    save(); renderFoods();
  };

  // ====== goals ======
  saveGoals.onclick = () => {
    const gp = Number(goalProteinInp.value);
    const gw = Number(goalWaterInp.value);
    if (isFinite(gp) && gp >= 0) state.goals.protein = Math.round(gp);
    if (isFinite(gw) && gw >= 0) state.goals.water = Math.round(gw);
    save(); renderTotals();
  };

  // ====== backup ======
  exportBtn.onclick = () => {
    backupArea.value = JSON.stringify(state);
  };

  importBtn.onclick = () => {
    try {
      if (!confirm("–ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;
      const obj = JSON.parse(backupArea.value || "");
      if (!obj || typeof obj !== "object") throw new Error("bad");
      if (!obj.days || !obj.foods) throw new Error("bad2");
      state = obj;
      ensureDay(state.selectedDate || todayISO());
      save();
      render();
      alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.");
    } catch {
      alert("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å—Ç–∞–≤–∏–ª –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞.");
    }
  };

  // ====== init ======
  ensureDay(state.selectedDate);
  goalProteinInp.value = state.goals?.protein ?? 130;
  goalWaterInp.value = state.goals?.water ?? 2500;
  save();
  render();
})();
</script>
</body>
</html>
/* ===== Mobile tidy pack ===== */
@media (max-width: 820px){
  .grid2, .grid3 { grid-template-columns: 1fr !important; }
  select { min-width: 100% !important; }
  input[type="number"]{ width: 100% !important; }
  .row { gap: 8px !important; }
  .pill { flex: 1 1 auto; }
  .card { padding: 12px !important; }
  table th:nth-child(3), table td:nth-child(3),
  table th:nth-child(5), table td:nth-child(5),
  table th:nth-child(6), table td:nth-child(6),
  table th:nth-child(7), table td:nth-child(7){
    display:none; /* —Å–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
  }
}
